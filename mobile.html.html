<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Car Audio V4 ‚Äî Mobile</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent
        }

        :root {
            --bg: #0a0a0f;
            --card: #12121a;
            --card2: #1a1a28;
            --border: #2a2a3a;
            --accent: #6c5ce7;
            --accent2: #a29bfe;
            --green: #00b894;
            --orange: #fdcb6e;
            --red: #e17055;
            --cyan: #81ecec;
            --pink: #fd79a8;
            --text: #e0e0e0;
            --text2: #a0a0b0;
            --gold: #f9ca24
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch
        }

        .header {
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1040 50%, #0a0a1a 100%);
            padding: 16px;
            border-bottom: 1px solid var(--border);
            text-align: center
        }

        .header h1 {
            font-size: 18px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent2), var(--cyan));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px
        }

        .header p {
            color: var(--text2);
            font-size: 11px;
            font-weight: 300
        }

        .header .car-badge {
            display: inline-block;
            background: var(--card2);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2px 12px;
            font-size: 10px;
            color: var(--accent2);
            margin-top: 6px
        }

        .header .version {
            font-size: 9px;
            color: var(--green);
            margin-top: 3px;
            letter-spacing: .5px
        }

        .container {
            padding: 10px;
            max-width: 600px;
            margin: 0 auto
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent)
        }

        .card h2 {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent2);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px
        }

        .card h2 .icon {
            font-size: 14px
        }

        .card h3 {
            font-size: 11px;
            font-weight: 600;
            color: var(--text2);
            margin: 10px 0 6px;
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .chart-wrap {
            position: relative;
            height: 220px;
            margin: 8px 0
        }

        .chart-wrap.tall {
            height: 260px
        }

        .slider-group {
            margin: 6px 0
        }

        .slider-group label {
            font-size: 11px;
            color: var(--text2);
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px
        }

        .slider-group label span {
            color: var(--accent2);
            font-weight: 600
        }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--card2);
            outline: none;
            border: 1px solid var(--border);
            touch-action: manipulation
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(108, 92, 231, .5)
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px
        }

        .stat {
            background: var(--card2);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border)
        }

        .stat .val {
            font-size: 16px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent2), var(--cyan));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .stat .lbl {
            font-size: 8px;
            color: var(--text2);
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: .3px
        }

        .tip {
            background: var(--card2);
            border-left: 3px solid var(--accent);
            border-radius: 0 6px 6px 0;
            padding: 8px 10px;
            font-size: 10px;
            color: var(--text2);
            margin: 8px 0;
            line-height: 1.5
        }

        .tip strong {
            color: var(--green)
        }

        .tip.warn {
            border-left-color: var(--orange)
        }

        .tip.warn strong {
            color: var(--orange)
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600
        }

        .badge.on {
            background: rgba(0, 184, 148, .15);
            color: var(--green);
            border: 1px solid rgba(0, 184, 148, .3)
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            margin: 6px 0
        }

        table th {
            text-align: left;
            color: var(--text2);
            font-weight: 600;
            padding: 6px 4px;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            font-size: 8px;
            letter-spacing: .3px
        }

        table td {
            padding: 6px 4px;
            border-bottom: 1px solid rgba(42, 42, 58, .5);
            color: var(--text)
        }

        .config-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px
        }

        .config-item {
            background: var(--card2);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid var(--border)
        }

        .config-item .title {
            font-size: 9px;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: .3px;
            margin-bottom: 4px
        }

        .config-item .value {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent2)
        }

        .config-item .detail {
            font-size: 9px;
            color: var(--text2);
            margin-top: 3px
        }

        .legend-custom {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 6px 0;
            font-size: 9px
        }

        .legend-custom .item {
            display: flex;
            align-items: center;
            gap: 3px
        }

        .legend-custom .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%
        }

        .eq-3band {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin: 10px 0
        }

        .eq-knob {
            background: var(--card2);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            border: 1px solid var(--border)
        }

        .eq-knob .band-name {
            font-size: 11px;
            font-weight: 700;
            color: var(--accent2);
            margin-bottom: 2px
        }

        .eq-knob .band-range {
            font-size: 8px;
            color: var(--text2);
            margin-bottom: 6px
        }

        .eq-knob .band-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--cyan);
            margin: 4px 0
        }

        .eq-knob .band-reason {
            font-size: 9px;
            color: var(--text2);
            margin-top: 6px;
            line-height: 1.3
        }

        /* V4: 5 Preset Tabs ‚Äî grid for mobile */
        .preset-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            margin-bottom: 10px
        }

        .preset-tabs .wide {
            grid-column: span 1
        }

        .preset-btn {
            padding: 7px 4px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--card2);
            color: var(--text2);
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            font-family: 'Inter', sans-serif;
            text-align: center;
            touch-action: manipulation
        }

        .preset-btn:hover,
        .preset-btn:active {
            border-color: var(--accent);
            color: var(--accent2)
        }

        .preset-btn.active {
            background: rgba(108, 92, 231, .2);
            border-color: var(--accent);
            color: var(--accent2);
            box-shadow: 0 0 8px rgba(108, 92, 231, .3)
        }

        .preset-btn .emoji {
            margin-right: 2px
        }

        .visor-display {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--card2);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 3px 10px;
            font-size: 16px;
            font-weight: 800;
            color: var(--green);
            font-family: 'Courier New', monospace;
            min-width: 50px;
            justify-content: center
        }

        .section-toggle {
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            color: var(--accent2);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 10px
        }

        .section-toggle::after {
            content: '‚ñº';
            font-size: 10px;
            transition: transform .2s;
            margin-left: auto
        }

        .section-toggle.open::after {
            transform: rotate(180deg)
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height .3s ease
        }

        .section-content.open {
            max-height: 4000px
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üîä Car Audio Analyzer</h1>
        <p>5 Presets calibrados + Visor 0-30 + RCA 5V</p>
        <div class="car-badge">üöó VW Up! TSI 2017</div>
        <div class="version">V4.1 ‚Äî Raz√£o 78:65 calibrada em 5 presets</div>
    </div>
    <div class="container">

        <!-- Controls -->
        <div class="card">
            <h2><span class="icon">üéõÔ∏è</span> Controle de Ganho</h2>
            <div class="preset-tabs">
                <button class="preset-btn" onclick="setPreset('max')" id="presetMax"><span
                        class="emoji">üî•</span>M√°ximo</button>
                <button class="preset-btn active" onclick="setPreset('potente')" id="presetPotente"><span
                        class="emoji">üí™</span>Potente</button>
                <button class="preset-btn" onclick="setPreset('media')" id="presetMedia"><span
                        class="emoji">üéµ</span>M√©dia</button>
                <button class="preset-btn" onclick="setPreset('natural')" id="presetNatural"><span
                        class="emoji">üåø</span>Natural</button>
                <button class="preset-btn" onclick="setPreset('baixo')" id="presetBaixo"><span
                        class="emoji">üîà</span>Baixo</button>
            </div>
            <div id="presetDesc"
                style="font-size:9px;color:var(--text2);margin-bottom:8px;padding:5px 8px;background:var(--card2);border-radius:5px;border-left:2px solid var(--accent)">
                üí™ Mesma curva do M√°ximo, volume de estrada. ~121dB m√°x.
            </div>
            <div class="slider-group">
                <label>Ganho Frente (Kit 2V) <span id="gainFrontVal">40%</span></label>
                <input type="range" id="gainFront" min="0" max="100" value="40" oninput="updateAll()">
            </div>
            <div class="slider-group">
                <label>Ganho Sub (Bridge) <span id="gainSubVal">33%</span></label>
                <input type="range" id="gainSub" min="0" max="100" value="33" oninput="updateAll()">
            </div>
            <div class="slider-group">
                <label>HPF Frente <span id="hpfVal">80 Hz</span></label>
                <input type="range" id="hpfFreq" min="50" max="150" value="80" step="5" oninput="updateAll()">
            </div>
            <div class="slider-group">
                <label>LPF Sub <span id="lpfVal">80 Hz</span></label>
                <input type="range" id="lpfFreq" min="50" max="150" value="80" step="5" oninput="updateAll()">
            </div>
            <div class="slider-group">
                <label>üîä Visor Up! TSI
                    <span><span class="visor-display" id="visorDisplay">20</span></span>
                </label>
                <input type="range" id="volSource" min="0" max="30" value="20" oninput="updateAll()">
            </div>
        </div>

        <!-- SPL Stats -->
        <div class="card">
            <h2><span class="icon">üìä</span> SPL Estimado</h2>
            <div class="stat-grid">
                <div class="stat">
                    <div class="val" id="splFront">‚Äî</div>
                    <div class="lbl">Frente</div>
                </div>
                <div class="stat">
                    <div class="val" id="splSub">‚Äî</div>
                    <div class="lbl">Sub</div>
                </div>
                <div class="stat">
                    <div class="val" id="splTotal">‚Äî</div>
                    <div class="lbl">Sistema</div>
                </div>
                <div class="stat">
                    <div class="val" id="splPeak">‚Äî</div>
                    <div class="lbl">Pico</div>
                </div>
                <div class="stat">
                    <div class="val" id="pwrFront">‚Äî</div>
                    <div class="lbl">W Frente</div>
                </div>
                <div class="stat">
                    <div class="val" id="pwrSub">‚Äî</div>
                    <div class="lbl">W Sub</div>
                </div>
            </div>
            <div class="tip warn" style="margin-top:8px"><strong>‚ö†Ô∏è</strong> Sub 200W RMS max. Nunca passe de ~75% do
                ganho sub.</div>
        </div>

        <!-- Individual Curves -->
        <div class="card">
            <button class="section-toggle" onclick="toggleSection(this,'secIndiv')"><span class="icon">üìà</span> Curvas
                Individuais</button>
            <div class="section-content" id="secIndiv">
                <div class="legend-custom">
                    <div class="item">
                        <div class="dot" style="background:#a29bfe"></div> Kit 2V
                    </div>
                    <div class="item">
                        <div class="dot" style="background:#fd79a8"></div> Mid
                    </div>
                    <div class="item">
                        <div class="dot" style="background:#81ecec"></div> Tw
                    </div>
                    <div class="item">
                        <div class="dot" style="background:#e17055"></div> Sub
                    </div>
                </div>
                <div class="chart-wrap tall"><canvas id="chartIndividual"></canvas></div>
            </div>
        </div>

        <!-- Combined -->
        <div class="card">
            <button class="section-toggle open" onclick="toggleSection(this,'secCombined')"><span class="icon">üéØ</span>
                Resposta Combinada</button>
            <div class="section-content open" id="secCombined">
                <div class="legend-custom">
                    <div class="item">
                        <div class="dot" style="background:#6c5ce7"></div> Total
                    </div>
                    <div class="item">
                        <div class="dot" style="background:rgba(249,202,36,.5)"></div> Harman
                    </div>
                    <div class="item">
                        <div class="dot" style="background:rgba(0,184,148,.3)"></div> ¬±3dB
                    </div>
                </div>
                <div class="chart-wrap tall"><canvas id="chartCombined"></canvas></div>
                <div class="tip"><strong>Curva calibrada:</strong> Todos os 5 presets mant√™m a mesma forma ‚Äî s√≥ muda o
                    volume.</div>
            </div>
        </div>

        <!-- Decomposition -->
        <div class="card">
            <button class="section-toggle" onclick="toggleSection(this,'secDecomp')"><span class="icon">üî¨</span>
                Decomposi√ß√£o por Driver</button>
            <div class="section-content" id="secDecomp">
                <div class="legend-custom">
                    <div class="item">
                        <div class="dot" style="background:#6c5ce7"></div> Total
                    </div>
                    <div class="item">
                        <div class="dot" style="background:#e17055"></div> Sub
                    </div>
                    <div class="item">
                        <div class="dot" style="background:#fd79a8"></div> Mid
                    </div>
                    <div class="item">
                        <div class="dot" style="background:#81ecec"></div> Tw
                    </div>
                </div>
                <div class="chart-wrap tall"><canvas id="chartDecomp"></canvas></div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card">
            <button class="section-toggle" onclick="toggleSection(this,'secFilters')"><span class="icon">üîÄ</span>
                Filtros e Crossover</button>
            <div class="section-content" id="secFilters">
                <div class="legend-custom">
                    <div class="item">
                        <div class="dot" style="background:#00b894"></div> HPF
                    </div>
                    <div class="item">
                        <div class="dot" style="background:#e17055"></div> LPF
                    </div>
                    <div class="item">
                        <div class="dot" style="background:#fdcb6e"></div> XO 3.5k
                    </div>
                </div>
                <div class="chart-wrap"><canvas id="chartFilters"></canvas></div>
            </div>
        </div>

        <!-- EQ -->
        <div class="card">
            <button class="section-toggle" onclick="toggleSection(this,'secEQ')"><span class="icon">üéöÔ∏è</span> EQ
                Recomendado ‚Äî R√°dio VW Up!</button>
            <div class="section-content" id="secEQ">
                <p style="font-size:10px;color:var(--text2);margin-bottom:6px">Ajuste para preservar a curva modelada em
                    todos os 5 presets.</p>
                <div class="eq-3band">
                    <div class="eq-knob">
                        <div class="band-name">üîà BASS</div>
                        <div class="band-range">~60‚Äì250Hz</div>
                        <div class="band-value">0</div>
                        <div class="band-reason">Sub + cabin = <strong style="color:var(--green)">curva correta</strong>
                        </div>
                    </div>
                    <div class="eq-knob">
                        <div class="band-name">üéôÔ∏è MID</div>
                        <div class="band-range">~500‚Äì2kHz</div>
                        <div class="band-value">+1</div>
                        <div class="band-reason">Compensa <strong style="color:var(--cyan)">dip 200-500Hz</strong></div>
                    </div>
                    <div class="eq-knob">
                        <div class="band-name">‚ú® TREBLE</div>
                        <div class="band-range">~4k‚Äì16kHz</div>
                        <div class="band-value">0</div>
                        <div class="band-reason">Tweeter PEI <strong style="color:var(--green)">natural</strong></div>
                    </div>
                </div>
                <div class="tip"><strong>Loudness/Bass Boost DESLIGADOS.</strong> Para Natural e Baixo, tente
                    <strong style="color:var(--orange)">Bass +1</strong> se quiser mais corpo.
                </div>
            </div>
        </div>

        <!-- Config -->
        <div class="card">
            <button class="section-toggle" onclick="toggleSection(this,'secConfig')"><span class="icon">‚úÖ</span>
                Configura√ß√£o Final</button>
            <div class="section-content" id="secConfig">
                <div class="config-summary">
                    <div class="config-item">
                        <div class="title">Ganho Front</div>
                        <div class="value" id="cfgGainF">40%</div>
                        <div class="detail" id="cfgPwrF">‚âà 21W/ch</div>
                    </div>
                    <div class="config-item">
                        <div class="title">Ganho Sub</div>
                        <div class="value" id="cfgGainS">33%</div>
                        <div class="detail" id="cfgPwrS">‚âà 44W brg</div>
                    </div>
                    <div class="config-item">
                        <div class="title">HPF</div>
                        <div class="value" id="cfgHPF">80Hz</div>
                        <div class="detail">12dB/oct</div>
                    </div>
                    <div class="config-item">
                        <div class="title">LPF</div>
                        <div class="value" id="cfgLPF">80Hz</div>
                        <div class="detail">12dB/oct</div>
                    </div>
                    <div class="config-item">
                        <div class="title">Visor</div>
                        <div class="value" id="cfgVol">20</div>
                        <div class="detail">Volume m√≠dia</div>
                    </div>
                    <div class="config-item">
                        <div class="title">Preset</div>
                        <div class="value" id="cfgPreset">üí™ Potente</div>
                        <div class="detail">Raz√£o 78:65</div>
                    </div>
                    <div class="config-item">
                        <div class="title">XO Passivo</div>
                        <div class="value">3.5kHz</div>
                        <div class="detail">Kit Hertz</div>
                    </div>
                    <div class="config-item">
                        <div class="title">RCA</div>
                        <div class="value">5V RMS</div>
                        <div class="detail">+8dB boost</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Volume Sensation -->
        <div class="card">
            <button class="section-toggle" onclick="toggleSection(this,'secSensation')"><span class="icon">üéß</span> SPL
                por N√≠vel do Visor</button>
            <div class="section-content" id="secSensation">
                <table id="volSensationTable">
                    <tr>
                        <th>Visor</th>
                        <th>Pot</th>
                        <th>SPL</th>
                        <th>Fr</th>
                        <th>Sub</th>
                        <th>Nota</th>
                    </tr>
                </table>
            </div>
        </div>

    </div>

    <script>
        function toggleSection(btn, id) { const c = document.getElementById(id); const open = c.classList.toggle('open'); btn.classList.toggle('open', open) }

        function genFreqs() { const f = []; for (let i = Math.log10(20); i <= Math.log10(20000); i += 0.025) f.push(Math.pow(10, i)); return f }
        const freqs = genFreqs();

        const vRCA = 5.0, vRef = 2.0;
        const rcaBoostDB = 20 * Math.log10(vRCA / vRef);

        // V4.1: 5 Presets calibrados ‚Äî MESMA RAZ√ÉO (78:65 ‚âà 0.833) em todos
        const presets = {
            max: { gF: 78, gS: 65, emoji: 'üî•', name: 'M√°ximo c/ Qualidade', desc: 'üî• Curva de refer√™ncia. ~126dB m√°x.' },
            potente: { gF: 40, gS: 33, emoji: 'üí™', name: 'Potente', desc: 'üí™ Mesma curva, volume de estrada. ~121dB m√°x.' },
            media: { gF: 30, gS: 25, emoji: 'üéµ', name: 'M√©dia', desc: 'üéµ Mesma curva, dia a dia. ~119dB m√°x.' },
            natural: { gF: 15, gS: 13, emoji: 'üåø', name: 'Volume Natural', desc: 'üåø Mesma curva, ~113dB m√°x.' },
            baixo: { gF: 7, gS: 6, emoji: 'üîà', name: 'Volume Baixo', desc: 'üîà Som ambiente Hi-Fi. ~106dB m√°x. Bass +1 opcional.' }
        };
        let activePreset = 'potente';

        function setPreset(id) {
            const p = presets[id];
            document.getElementById('gainFront').value = p.gF;
            document.getElementById('gainSub').value = p.gS;
            activePreset = id;
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('preset' + id.charAt(0).toUpperCase() + id.slice(1)).classList.add('active');
            document.getElementById('presetDesc').innerHTML = p.desc;
            document.getElementById('cfgPreset').textContent = p.emoji + ' ' + p.name;
            updateAll();
        }

        function displayToPower(d) {
            const pts = [[0, 0], [5, 0.03], [10, 0.09], [15, 0.22], [20, 0.50], [25, 0.77], [27, 0.80], [30, 1.00]];
            if (d <= 0) return 0.0001;
            if (d >= 30) return 1.0;
            for (let i = 0; i < pts.length - 1; i++) {
                if (d >= pts[i][0] && d <= pts[i + 1][0]) {
                    const [d0, p0] = pts[i], [d1, p1] = pts[i + 1];
                    return Math.max(0.0001, p0 + (p1 - p0) * (d - d0) / (d1 - d0));
                }
            }
            return 1.0;
        }

        function hpf12(f, fc) { const r = fc / f; return -10 * Math.log10(1 + Math.pow(r, 4)) }
        function lpf12(f, fc) { const r = f / fc; return -10 * Math.log10(1 + Math.pow(r, 4)) }

        function subResponse(f) {
            if (f < 20) return -40;
            const ft = 50;
            const peak = 2.2 * Math.exp(-Math.pow((f - ft) / 18, 2));
            const loRoll = f < ft ? -15 * Math.log10(ft / f) : 0;
            const hiRoll = f > 200 ? -12 * Math.log10(f / 200) : 0;
            return Math.max(peak + loRoll + hiRoll, -40);
        }

        function midBassResponse(f) {
            if (f < 30) return -40;
            let spl = 0;
            if (f < 50) spl = -12 * Math.log10(50 / f);
            spl += 2 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(120)) / 0.3, 2));
            spl -= 1.0 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(450)) / 0.22, 2));
            spl += 1 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(2500)) / 0.15, 2));
            spl += lpf12(f, 3500);
            return Math.max(spl, -40);
        }

        function tweeterResponse(f) {
            if (f < 1000) return -40;
            let spl = hpf12(f, 3500);
            spl += 2 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(6000)) / 0.2, 2));
            if (f > 18000) spl -= 12 * Math.log10(f / 18000);
            spl += 1 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(10000)) / 0.25, 2));
            return Math.max(spl, -40);
        }

        function cabinTF(f) {
            let gain = 0;
            if (f < 200) gain += 7 * Math.pow(Math.max(0, (200 - f) / 200), 1.3);
            gain += 1.2 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(65)) / 0.1, 2));
            gain += 0.8 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(130)) / 0.08, 2));
            gain -= 1.5 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(250)) / 0.12, 2));
            gain += 0.6 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(180)) / 0.1, 2));
            if (f > 5000) gain -= 2 * Math.log10(f / 5000);
            return gain;
        }

        function harmanTarget(f) {
            let t = 0;
            if (f < 200) t = 6 * Math.pow(Math.max(0, (200 - f) / 200), 0.6);
            if (f > 1000) t -= 0.5 * Math.log2(f / 1000);
            t += 1 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(3000)) / 0.2, 2));
            return t;
        }

        let chartIndividual, chartCombined, chartDecomp, chartFilters;
        const mobileFont = { size: 8 };

        function initCharts() {
            const commonOpts = {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'logarithmic', min: 20, max: 20000, title: { display: true, text: 'Frequ√™ncia (Hz)', color: '#a0a0b0', font: mobileFont },
                        ticks: {
                            color: '#a0a0b0', font: mobileFont, maxRotation: 0, callback: function (v) {
                                const nice = [20, 50, 100, 200, 500, 1000, 5000, 20000];
                                if (nice.includes(Math.round(v))) return v < 1000 ? v : (v / 1000) + 'k'; return ''
                            }
                        }, grid: { color: 'rgba(42,42,58,.5)' }
                    },
                    y: { min: -30, max: 15, title: { display: false }, ticks: { color: '#a0a0b0', font: mobileFont }, grid: { color: 'rgba(42,42,58,.3)' } }
                },
                plugins: {
                    legend: { display: false }, tooltip: {
                        titleFont: mobileFont, bodyFont: mobileFont,
                        callbacks: {
                            title: function (items) { const f = items[0].parsed.x; return f < 1000 ? Math.round(f) + 'Hz' : (f / 1000).toFixed(1) + 'kHz' },
                            label: function (ctx) { return ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(1) + 'dB' }
                        }
                    }
                },
                interaction: { mode: 'nearest', axis: 'x', intersect: false },
                elements: { point: { radius: 0 }, line: { tension: 0.3, borderWidth: 2 } }
            };

            chartIndividual = new Chart(document.getElementById('chartIndividual'), {
                type: 'line', data: {
                    labels: freqs, datasets: [
                        { label: 'Kit 2V', data: [], borderColor: '#a29bfe', backgroundColor: 'rgba(162,155,254,.1)', fill: true },
                        { label: 'Mid', data: [], borderColor: '#fd79a8', borderDash: [4, 2], borderWidth: 1.5 },
                        { label: 'Tw', data: [], borderColor: '#81ecec', borderDash: [4, 2], borderWidth: 1.5 },
                        { label: 'Sub', data: [], borderColor: '#e17055', backgroundColor: 'rgba(225,112,85,.1)', fill: true }
                    ]
                }, options: { ...commonOpts }
            });

            const cOpts = JSON.parse(JSON.stringify(commonOpts));
            cOpts.scales.y.min = -20; cOpts.scales.y.max = 20;
            chartCombined = new Chart(document.getElementById('chartCombined'), {
                type: 'line', data: {
                    labels: freqs, datasets: [
                        { label: 'Total', data: [], borderColor: '#6c5ce7', backgroundColor: 'rgba(108,92,231,.15)', borderWidth: 2.5, fill: true },
                        { label: 'Harman', data: [], borderColor: 'rgba(249,202,36,.7)', borderWidth: 1.5, borderDash: [6, 3] },
                        { label: '+3dB', data: [], borderColor: 'rgba(0,184,148,.2)', backgroundColor: 'rgba(0,184,148,.05)', borderWidth: 1, fill: '+1' },
                        { label: '-3dB', data: [], borderColor: 'rgba(0,184,148,.2)', borderWidth: 1 }
                    ]
                }, options: cOpts
            });

            const dOpts = JSON.parse(JSON.stringify(commonOpts));
            dOpts.scales.y.min = -20; dOpts.scales.y.max = 20;
            chartDecomp = new Chart(document.getElementById('chartDecomp'), {
                type: 'line', data: {
                    labels: freqs, datasets: [
                        { label: 'Total', data: [], borderColor: '#6c5ce7', backgroundColor: 'rgba(108,92,231,.10)', borderWidth: 2.5, fill: true },
                        { label: 'Sub', data: [], borderColor: '#e17055', borderWidth: 1.5, backgroundColor: 'rgba(225,112,85,.06)', fill: true },
                        { label: 'Mid', data: [], borderColor: '#fd79a8', borderWidth: 1.5, backgroundColor: 'rgba(253,121,168,.06)', fill: true },
                        { label: 'Tw', data: [], borderColor: '#81ecec', borderWidth: 1.5, backgroundColor: 'rgba(129,236,236,.06)', fill: true },
                        { label: 'Alvo', data: [], borderColor: 'rgba(249,202,36,.5)', borderWidth: 1.5, borderDash: [6, 3] }
                    ]
                }, options: dOpts
            });

            const fOpts = JSON.parse(JSON.stringify(commonOpts));
            fOpts.scales.y.min = -35; fOpts.scales.y.max = 5;
            chartFilters = new Chart(document.getElementById('chartFilters'), {
                type: 'line', data: {
                    labels: freqs, datasets: [
                        { label: 'HPF', data: [], borderColor: '#00b894' },
                        { label: 'LPF', data: [], borderColor: '#e17055' },
                        { label: 'XO LP', data: [], borderColor: '#fdcb6e', borderWidth: 1.5, borderDash: [4, 2] },
                        { label: 'XO HP', data: [], borderColor: '#81ecec', borderWidth: 1.5, borderDash: [4, 2] }
                    ]
                }, options: fOpts
            });
            updateAll();
        }

        function calcSPLat(gF, gS, volFactor) {
            const pwrF = 132 * Math.pow(gF / 100, 2);
            const pwrS = 400 * Math.pow(gS / 100, 2);
            const splF = 93 + 10 * Math.log10(Math.max(0.001, pwrF * volFactor)) + rcaBoostDB;
            const splS = 87 + 10 * Math.log10(Math.max(0.001, pwrS * volFactor)) + rcaBoostDB;
            const sFB = splF + 3, sCab = splS + 8;
            const sSys = 10 * Math.log10(Math.pow(10, sFB / 10) + Math.pow(10, sCab / 10));
            return { splF: sFB, splS: sCab, splSys: sSys, pwrF: pwrF * volFactor, pwrS: pwrS * volFactor };
        }

        function updateVolSensationTable(gF, gS) {
            const levels = [
                { d: 5, desc: 'Fundo leve' }, { d: 8, desc: 'Ambiente' },
                { d: 10, desc: 'Conversa' }, { d: 12, desc: 'Cruising' },
                { d: 15, desc: 'Estrada' }, { d: 18, desc: 'Animado' },
                { d: 20, desc: 'Dia a dia' }, { d: 22, desc: 'Alto' },
                { d: 25, desc: 'Performance' }, { d: 27, desc: 'Limite limpo' },
                { d: 30, desc: 'Max ‚Äî clip!' }
            ];
            let html = '<tr><th>Visor</th><th>Pot</th><th>SPL</th><th>Fr</th><th>Sub</th><th>Nota</th></tr>';
            levels.forEach(l => {
                const pf = displayToPower(l.d);
                const r = calcSPLat(gF, gS, pf);
                const hl = l.d === 20 ? ' style="background:rgba(108,92,231,.1);font-weight:600"' : '';
                html += `<tr${hl}><td>${l.d}</td><td>${(pf * 100).toFixed(0)}%</td><td>${r.splSys.toFixed(1)}</td><td>${r.pwrF.toFixed(0)}W</td><td>${r.pwrS.toFixed(0)}W</td><td>${l.desc}</td></tr>`;
            });
            document.getElementById('volSensationTable').innerHTML = html;
        }

        function updateAll() {
            const gF = parseInt(document.getElementById('gainFront').value);
            const gS = parseInt(document.getElementById('gainSub').value);
            const hpf = parseInt(document.getElementById('hpfFreq').value);
            const lpf = parseInt(document.getElementById('lpfFreq').value);
            const visor = parseInt(document.getElementById('volSource').value);
            const volFactor = displayToPower(visor);

            document.getElementById('gainFrontVal').textContent = gF + '%';
            document.getElementById('gainSubVal').textContent = gS + '%';
            document.getElementById('hpfVal').textContent = hpf + ' Hz';
            document.getElementById('lpfVal').textContent = lpf + ' Hz';
            document.getElementById('visorDisplay').textContent = visor;

            const pwrF = 132 * Math.pow(gF / 100, 2);
            const pwrS = 400 * Math.pow(gS / 100, 2);

            const splF = 93 + 10 * Math.log10(Math.max(0.001, pwrF * volFactor)) + rcaBoostDB;
            const splS = 87 + 10 * Math.log10(Math.max(0.001, pwrS * volFactor)) + rcaBoostDB;
            const splSCabin = splS + 8;
            const splFBoth = splF + 3;
            const splSys = 10 * Math.log10(Math.pow(10, splFBoth / 10) + Math.pow(10, splSCabin / 10));

            document.getElementById('splFront').textContent = splFBoth.toFixed(1) + ' dB';
            document.getElementById('splSub').textContent = splSCabin.toFixed(1) + ' dB';
            document.getElementById('splTotal').textContent = splSys.toFixed(1) + ' dB';
            document.getElementById('splPeak').textContent = (splSys + 3).toFixed(1) + ' dB';
            document.getElementById('pwrFront').textContent = (pwrF * volFactor).toFixed(0) + 'W';
            document.getElementById('pwrSub').textContent = (pwrS * volFactor).toFixed(0) + 'W';

            document.getElementById('cfgGainF').textContent = gF + '%';
            document.getElementById('cfgGainS').textContent = gS + '%';
            document.getElementById('cfgHPF').textContent = hpf + 'Hz';
            document.getElementById('cfgLPF').textContent = lpf + 'Hz';
            document.getElementById('cfgVol').textContent = visor;
            document.getElementById('cfgPwrF').textContent = '‚âà ' + (pwrF * volFactor).toFixed(0) + 'W/ch';
            document.getElementById('cfgPwrS').textContent = '‚âà ' + (pwrS * volFactor).toFixed(0) + 'W brg';

            const gainFdB = 20 * Math.log10(Math.max(0.01, gF / 100)) + 20 * Math.log10(Math.max(0.01, Math.sqrt(volFactor))) + rcaBoostDB;
            const gainSdB = 20 * Math.log10(Math.max(0.01, gS / 100)) + 20 * Math.log10(Math.max(0.01, Math.sqrt(volFactor))) + rcaBoostDB;

            const kitData = [], mbData = [], twData = [], subData = [];
            freqs.forEach(f => {
                const mb = midBassResponse(f) + hpf12(f, hpf);
                const tw = tweeterResponse(f) + hpf12(f, hpf);
                kitData.push({ x: f, y: 10 * Math.log10(Math.pow(10, mb / 10) + Math.pow(10, tw / 10)) });
                mbData.push({ x: f, y: mb }); twData.push({ x: f, y: tw });
                subData.push({ x: f, y: subResponse(f) + lpf12(f, lpf) });
            });
            chartIndividual.data.datasets[0].data = kitData;
            chartIndividual.data.datasets[1].data = mbData;
            chartIndividual.data.datasets[2].data = twData;
            chartIndividual.data.datasets[3].data = subData;
            chartIndividual.update('none');

            const combinedData = [], targetData = [], upperData = [], lowerData = [];
            const decompSubData = [], decompMbData = [], decompTwData = [];
            freqs.forEach(f => {
                const mb = midBassResponse(f) + hpf12(f, hpf) + gainFdB;
                const tw = tweeterResponse(f) + hpf12(f, hpf) + gainFdB;
                const sub = subResponse(f) + lpf12(f, lpf) + gainSdB;
                const cabin = cabinTF(f);
                const totalDB = 10 * Math.log10(Math.max(1e-10, Math.pow(10, mb / 10) + Math.pow(10, tw / 10) + Math.pow(10, sub / 10))) + cabin;
                combinedData.push({ x: f, y: totalDB });
                decompSubData.push({ x: f, y: sub + cabin });
                decompMbData.push({ x: f, y: mb + cabin });
                decompTwData.push({ x: f, y: tw + cabin });
                const target = harmanTarget(f);
                targetData.push({ x: f, y: target });
                upperData.push({ x: f, y: target + 3 });
                lowerData.push({ x: f, y: target - 3 });
            });
            const ref1k = combinedData.find(d => d.x >= 1000);
            const offset = ref1k ? ref1k.y : 0;
            combinedData.forEach(d => d.y -= offset);
            decompSubData.forEach(d => d.y -= offset);
            decompMbData.forEach(d => d.y -= offset);
            decompTwData.forEach(d => d.y -= offset);

            chartCombined.data.datasets[0].data = combinedData;
            chartCombined.data.datasets[1].data = targetData;
            chartCombined.data.datasets[2].data = upperData;
            chartCombined.data.datasets[3].data = lowerData;
            chartCombined.update('none');

            chartDecomp.data.datasets[0].data = combinedData.map(d => ({ ...d }));
            chartDecomp.data.datasets[1].data = decompSubData;
            chartDecomp.data.datasets[2].data = decompMbData;
            chartDecomp.data.datasets[3].data = decompTwData;
            chartDecomp.data.datasets[4].data = targetData;
            chartDecomp.update('none');

            const hpfData = [], lpfData = [], xoLpf = [], xoHpf = [];
            freqs.forEach(f => {
                hpfData.push({ x: f, y: hpf12(f, hpf) });
                lpfData.push({ x: f, y: lpf12(f, lpf) });
                xoLpf.push({ x: f, y: lpf12(f, 3500) });
                xoHpf.push({ x: f, y: hpf12(f, 3500) });
            });
            chartFilters.data.datasets[0].data = hpfData;
            chartFilters.data.datasets[1].data = lpfData;
            chartFilters.data.datasets[2].data = xoLpf;
            chartFilters.data.datasets[3].data = xoHpf;
            chartFilters.update('none');

            updateVolSensationTable(gF, gS);
        }

        window.addEventListener('load', initCharts);
    </script>
    <script src="amp-guide.js"></script>
</body>

</html>