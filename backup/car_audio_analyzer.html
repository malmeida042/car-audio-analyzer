<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Car Audio Analyzer ‚Äî VW Up! TSI 2017</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--card:#12121a;--card2:#1a1a28;--border:#2a2a3a;--accent:#6c5ce7;--accent2:#a29bfe;--green:#00b894;--orange:#fdcb6e;--red:#e17055;--cyan:#81ecec;--pink:#fd79a8;--text:#e0e0e0;--text2:#a0a0b0;--gold:#f9ca24}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
.header{background:linear-gradient(135deg,#0a0a1a 0%,#1a1040 50%,#0a0a1a 100%);padding:30px 40px;border-bottom:1px solid var(--border);text-align:center}
.header h1{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--accent2),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}
.header p{color:var(--text2);font-size:14px;font-weight:300}
.header .car-badge{display:inline-block;background:var(--card2);border:1px solid var(--border);border-radius:20px;padding:4px 16px;font-size:12px;color:var(--accent2);margin-top:8px}
.container{max-width:1400px;margin:0 auto;padding:20px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px}
.full{grid-column:1/-1}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent)}
.card h2{font-size:15px;font-weight:700;color:var(--accent2);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.card h2 .icon{font-size:18px}
.card h3{font-size:13px;font-weight:600;color:var(--text2);margin:12px 0 8px;text-transform:uppercase;letter-spacing:1px}
.chart-wrap{position:relative;height:320px;margin:10px 0}
.chart-wrap.tall{height:420px}
.slider-group{margin:8px 0}
.slider-group label{font-size:12px;color:var(--text2);display:flex;justify-content:space-between;margin-bottom:4px}
.slider-group label span{color:var(--accent2);font-weight:600}
input[type=range]{-webkit-appearance:none;width:100%;height:6px;border-radius:3px;background:var(--card2);outline:none;border:1px solid var(--border)}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 10px rgba(108,92,231,.5)}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px}
.stat{background:var(--card2);border-radius:10px;padding:12px;text-align:center;border:1px solid var(--border)}
.stat .val{font-size:22px;font-weight:800;background:linear-gradient(135deg,var(--accent2),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat .lbl{font-size:10px;color:var(--text2);margin-top:2px;text-transform:uppercase;letter-spacing:.5px}
.eq-band{display:flex;flex-direction:column;align-items:center;gap:4px}
.eq-band input[type=range]{width:80px;transform:rotate(-90deg);margin:30px 0}
.eq-band .freq{font-size:10px;color:var(--text2)}
.eq-band .db{font-size:11px;color:var(--accent2);font-weight:600}
.eq-row{display:flex;justify-content:space-around;align-items:flex-end;padding:10px 0}
.tip{background:var(--card2);border-left:3px solid var(--accent);border-radius:0 8px 8px 0;padding:10px 14px;font-size:12px;color:var(--text2);margin:10px 0;line-height:1.6}
.tip strong{color:var(--green)}
.tip.warn{border-left-color:var(--orange)}
.tip.warn strong{color:var(--orange)}
.badge{display:inline-block;padding:2px 10px;border-radius:12px;font-size:11px;font-weight:600}
.badge.on{background:rgba(0,184,148,.15);color:var(--green);border:1px solid rgba(0,184,148,.3)}
.badge.off{background:rgba(225,112,85,.15);color:var(--red);border:1px solid rgba(225,112,85,.3)}
table{width:100%;border-collapse:collapse;font-size:12px;margin:8px 0}
table th{text-align:left;color:var(--text2);font-weight:600;padding:8px;border-bottom:1px solid var(--border);text-transform:uppercase;font-size:10px;letter-spacing:.5px}
table td{padding:8px;border-bottom:1px solid rgba(42,42,58,.5);color:var(--text)}
table tr:hover td{background:rgba(108,92,231,.05)}
.config-summary{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.config-item{background:var(--card2);border-radius:10px;padding:14px;border:1px solid var(--border)}
.config-item .title{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.config-item .value{font-size:16px;font-weight:700;color:var(--accent2)}
.config-item .detail{font-size:11px;color:var(--text2);margin-top:4px}
.legend-custom{display:flex;flex-wrap:wrap;gap:12px;margin:8px 0;font-size:11px}
.legend-custom .item{display:flex;align-items:center;gap:4px}
.legend-custom .dot{width:10px;height:10px;border-radius:50%}
@media(max-width:900px){.grid2,.grid3{grid-template-columns:1fr}.eq-row{flex-wrap:wrap}}
</style>
</head>
<body>
<div class="header">
<h1>üîä Car Audio Frequency Analyzer</h1>
<p>Configura√ß√£o Hi-Fi otimizada para m√°ximo Sound Quality + Volume</p>
<div class="car-badge">üöó VW Up! TSI 2017 ‚Äî Cabine ~2.6 m¬≥</div>
</div>
<div class="container">

<!-- Equipment Overview -->
<div class="card" style="margin-bottom:16px">
<h2><span class="icon">üìã</span> Equipamentos Instalados</h2>
<table>
<tr><th>Componente</th><th>Modelo</th><th>Pot√™ncia RMS</th><th>Imped√¢ncia</th><th>Sensibilidade</th><th>Faixa</th></tr>
<tr><td>M√≥dulo</td><td>SoundDigital 800.4 EVO6</td><td>4√ó132W@4Œ© / Bridge 2√ó400W@4Œ©</td><td>‚Äî</td><td>SNR 93dB</td><td>5Hz‚Äì20kHz</td></tr>
<tr><td>Kit 2 Vias (por porta)</td><td>Hertz DSK 165.3 + Crossover passivo</td><td>80W/lado</td><td>4Œ©</td><td>93 dB</td><td>50Hz‚Äì23kHz</td></tr>
<tr><td>Subwoofer (caixa dutada)</td><td>Hertz ES 200.5</td><td>200W</td><td>4Œ©</td><td>87 dB</td><td>30Hz‚Äì400Hz</td></tr>
<tr><td>Tratamento</td><td>Manta viscoel√°stica (portas)</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>Absor√ß√£o resson√¢ncia</td></tr>
</table>
</div>

<!-- Gain Controls + SPL -->
<div class="grid2">
<div class="card">
<h2><span class="icon">üéõÔ∏è</span> Controle de Ganho ‚Äî M√≥dulo SD 800.4</h2>
<div class="slider-group">
<label>Ganho Canais 1+2 (Frente ‚Äî Kit 2 Vias) <span id="gainFrontVal">78%</span></label>
<input type="range" id="gainFront" min="0" max="100" value="78" oninput="updateAll()">
</div>
<div class="slider-group">
<label>Ganho Canais 3+4 Bridge (Subwoofer) <span id="gainSubVal">71%</span></label>
<input type="range" id="gainSub" min="0" max="100" value="71" oninput="updateAll()">
</div>
<h3>Filtros do M√≥dulo</h3>
<div class="slider-group">
<label>HPF Frente (Hz) <span id="hpfVal">80 Hz</span></label>
<input type="range" id="hpfFreq" min="50" max="150" value="80" step="5" oninput="updateAll()">
</div>
<div class="slider-group">
<label>LPF Sub (Hz) <span id="lpfVal">80 Hz</span></label>
<input type="range" id="lpfFreq" min="50" max="150" value="80" step="5" oninput="updateAll()">
</div>
<div class="slider-group">
<label>Volume da Fonte (Head Unit) <span id="volVal">75%</span></label>
<input type="range" id="volSource" min="0" max="100" value="75" oninput="updateAll()">
</div>
<div class="tip"><strong>Dica:</strong> Os valores padr√£o j√° representam a configura√ß√£o √≥tima calculada. Ajuste para explorar como cada mudan√ßa afeta a curva.</div>
</div>
<div class="card">
<h2><span class="icon">üìä</span> SPL Estimado ‚Äî Banco do Motorista</h2>
<div class="stat-grid">
<div class="stat"><div class="val" id="splFront">‚Äî</div><div class="lbl">Frente (Kit 2V)</div></div>
<div class="stat"><div class="val" id="splSub">‚Äî</div><div class="lbl">Subwoofer</div></div>
<div class="stat"><div class="val" id="splTotal">‚Äî</div><div class="lbl">Sistema Total</div></div>
<div class="stat"><div class="val" id="splPeak">‚Äî</div><div class="lbl">Pico Estimado</div></div>
<div class="stat"><div class="val" id="pwrFront">‚Äî</div><div class="lbl">Pot√™ncia Frente</div></div>
<div class="stat"><div class="val" id="pwrSub">‚Äî</div><div class="lbl">Pot√™ncia Sub</div></div>
</div>
<div class="tip warn" style="margin-top:14px"><strong>‚ö†Ô∏è Aten√ß√£o:</strong> O sub Hertz ES 200.5 suporta apenas 200W RMS. Com o bridge entregando at√© 400W, <u>nunca passe de ~75% do ganho</u> nesse canal para evitar danos.</div>
<h3>Canaliza√ß√£o</h3>
<div class="config-summary">
<div class="config-item"><div class="title">Canal 1</div><div class="value">Porta Esquerda</div><div class="detail">Kit 2 Vias Hertz + Crossover passivo</div></div>
<div class="config-item"><div class="title">Canal 2</div><div class="value">Porta Direita</div><div class="detail">Kit 2 Vias Hertz + Crossover passivo</div></div>
<div class="config-item"><div class="title">Canal 3+4</div><div class="value">Bridge ‚Üí Sub</div><div class="detail">Hertz ES 200.5 ‚Äî Caixa dutada MDF</div></div>
<div class="config-item"><div class="title">Filtros</div><div class="value">HPF 80Hz / LPF 80Hz</div><div class="detail">12dB/oitava no m√≥dulo</div></div>
</div>
</div>
</div>

<!-- Individual Curves -->
<div class="card" style="margin-bottom:16px">
<h2><span class="icon">üìà</span> Curvas de Frequ√™ncia Individuais dos Componentes</h2>
<div class="legend-custom">
<div class="item"><div class="dot" style="background:#a29bfe"></div> Kit 2 Vias (com crossover passivo)</div>
<div class="item"><div class="dot" style="background:#fd79a8"></div> Mid-Bass (via crossover)</div>
<div class="item"><div class="dot" style="background:#81ecec"></div> Tweeter (via crossover)</div>
<div class="item"><div class="dot" style="background:#e17055"></div> Subwoofer (caixa dutada)</div>
</div>
<div class="chart-wrap tall"><canvas id="chartIndividual"></canvas></div>
</div>

<!-- Combined System Response -->
<div class="card" style="margin-bottom:16px">
<h2><span class="icon">üéØ</span> Resposta Combinada do Sistema ‚Äî Banco do Motorista</h2>
<div class="legend-custom">
<div class="item"><div class="dot" style="background:#6c5ce7"></div> Resposta Total Estimada</div>
<div class="item"><div class="dot" style="background:rgba(249,202,36,.5)"></div> Curva-Alvo Hi-Fi (Harman)</div>
<div class="item"><div class="dot" style="background:rgba(0,184,148,.3)"></div> Zona Ideal ¬±3dB</div>
</div>
<div class="chart-wrap tall"><canvas id="chartCombined"></canvas></div>
<div class="tip"><strong>Interpreta√ß√£o:</strong> A curva roxa √© a resposta estimada no banco do motorista com os ganhos atuais. A curva dourada √© a refer√™ncia Hi-Fi (Harman target curve com leve boost em graves para seu gosto). Quanto mais pr√≥ximas, melhor o sound quality.</div>
</div>

<!-- Filters Chart -->
<div class="card" style="margin-bottom:16px">
<h2><span class="icon">üîÄ</span> Ponto de Crossover e Filtros Ativos</h2>
<div class="legend-custom">
<div class="item"><div class="dot" style="background:#00b894"></div> HPF Frente</div>
<div class="item"><div class="dot" style="background:#e17055"></div> LPF Sub</div>
<div class="item"><div class="dot" style="background:#fdcb6e"></div> Crossover Passivo 3.5kHz</div>
</div>
<div class="chart-wrap"><canvas id="chartFilters"></canvas></div>
</div>

<!-- EQ + Config -->
<div class="grid2">
<div class="card">
<h2><span class="icon">üéöÔ∏è</span> EQ Recomendado ‚Äî Multim√≠dia Original VW Up!</h2>
<p style="font-size:12px;color:var(--text2);margin-bottom:10px">Ajuste o EQ da fonte (head unit) para compensar defici√™ncias da cabine. A multim√≠dia do Up! geralmente tem EQ de 5 ou 7 bandas.</p>
<table>
<tr><th>Banda</th><th>Freq. Aprox.</th><th>Ajuste</th><th>Motivo</th></tr>
<tr><td>Sub-Bass</td><td>60 Hz</td><td id="eq60">0 dB</td><td>Sub j√° complementa via m√≥dulo</td></tr>
<tr><td>Bass</td><td>150 Hz</td><td id="eq150">-2 dB</td><td>Evitar boom / resson√¢ncia cabine</td></tr>
<tr><td>Low-Mid</td><td>400 Hz</td><td id="eq400">-1 dB</td><td>Reduzir embolamento na cabine</td></tr>
<tr><td>Mid</td><td>1 kHz</td><td id="eq1k">+1 dB</td><td>Presen√ßa vocal, clareza</td></tr>
<tr><td>Upper-Mid</td><td>2.5 kHz</td><td id="eq2k">+2 dB</td><td>Detalhe e defini√ß√£o</td></tr>
<tr><td>Presence</td><td>6 kHz</td><td id="eq6k">+1 dB</td><td>Brilho sem sibil√¢ncia</td></tr>
<tr><td>Air</td><td>12 kHz</td><td id="eq12k">0 dB</td><td>Tweeter Hertz j√° cobre bem</td></tr>
</table>
<div class="tip"><strong>Modo de som:</strong> Se a multim√≠dia do Up! tiver presets, comece com "Flat" ou "M√∫sica" e aplique estes ajustes manualmente. <strong>Desative qualquer "Loudness" ou "Bass Boost"</strong> da fonte ‚Äî o m√≥dulo cuida disso.</div>
</div>
<div class="card">
<h2><span class="icon">‚úÖ</span> Configura√ß√£o Final Recomendada</h2>
<div class="config-summary">
<div class="config-item"><div class="title">Ganho Frente (Ch 1+2)</div><div class="value" id="cfgGainF">78%</div><div class="detail" id="cfgPwrF">‚âà 80W por canal</div></div>
<div class="config-item"><div class="title">Ganho Sub (Ch 3+4 Bridge)</div><div class="value" id="cfgGainS">71%</div><div class="detail" id="cfgPwrS">‚âà 200W bridge</div></div>
<div class="config-item"><div class="title">HPF Frente</div><div class="value" id="cfgHPF">80 Hz</div><div class="detail">12dB/oitava ‚Äî Ligado</div></div>
<div class="config-item"><div class="title">LPF Sub</div><div class="value" id="cfgLPF">80 Hz</div><div class="detail">12dB/oitava ‚Äî Ligado</div></div>
<div class="config-item"><div class="title">Volume Fonte</div><div class="value" id="cfgVol">75%</div><div class="detail">Sem distor√ß√£o no sinal RCA</div></div>
<div class="config-item"><div class="title">Crossover Passivo</div><div class="value">3.5 kHz</div><div class="detail">12dB/oct ‚Äî Integrado no kit Hertz</div></div>
</div>
<h3 style="margin-top:16px">Checklist de Instala√ß√£o</h3>
<table>
<tr><td>‚úÖ</td><td>Manta ac√∫stica nas portas dianteiras</td><td class="badge on">Essencial</td></tr>
<tr><td>‚úÖ</td><td>Crossover passivo Hertz entre m√≥dulo e falantes</td><td class="badge on">Usar o do kit</td></tr>
<tr><td>‚úÖ</td><td>Cabo de alimenta√ß√£o 7 AWG (10mm¬≤)</td><td class="badge on">Obrigat√≥rio</td></tr>
<tr><td>‚úÖ</td><td>Fus√≠vel 40A perto da bateria</td><td class="badge on">Seguran√ßa</td></tr>
<tr><td>‚úÖ</td><td>Aterramento curto e s√≥lido</td><td class="badge on">Performance</td></tr>
<tr><td>‚ö†Ô∏è</td><td>Cabos RCA blindados</td><td class="badge on">Recomendado</td></tr>
<tr><td>‚ö†Ô∏è</td><td>Tratar porta-malas (futuro)</td><td class="badge off">Opcional</td></tr>
</table>
</div>
</div>

<!-- Analysis Text -->
<div class="card" style="margin-top:16px">
<h2><span class="icon">üß†</span> An√°lise T√©cnica Detalhada</h2>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;font-size:12px;line-height:1.7;color:var(--text2)">
<div>
<h3>Integra√ß√£o Sub + Kit 2 Vias</h3>
<p>O ponto de crossover entre sub e kit frontal em <strong style="color:var(--green)">80 Hz</strong> √© ideal: o Hertz DSK 165.3 tem resposta a partir de 50Hz mas com excurs√£o excessiva abaixo de 80Hz; o HPF protege o mid-bass e reduz distor√ß√£o. O sub cobre 30‚Äì80Hz com sobra.</p>
<h3 style="margin-top:14px">Cabin Gain</h3>
<p>A cabine do Up! √© compacta (~2.6m¬≥), gerando <strong style="color:var(--cyan)">cabin gain de +8 a +12dB</strong> abaixo de 60Hz. Isso significa que seu sub de 87dB de sensibilidade efetivamente se comporta como ~97-99dB na cabine. A caixa dutada refor√ßa a faixa de tuning (~45-55Hz) com pico adicional de +3-4dB.</p>
</div>
<div>
<h3>Manta Ac√∫stica</h3>
<p>A manta viscoel√°stica nas portas √© <strong style="color:var(--green)">fundamental</strong> para o kit 2 vias: elimina resson√¢ncias da porta met√°lica (tipicamente 200-500Hz) que causam colora√ß√£o e mascaramento dos m√©dios. Resultado: m√©dios mais limpos e detalhados, imagem sonora melhor definida.</p>
<h3 style="margin-top:14px">Seu Perfil Sonoro</h3>
<p>Para graves profundos + detalhes Hi-Fi, a curva-alvo usa a <strong style="color:var(--gold)">Harman Target</strong> com <strong style="color:var(--pink)">shelf bass boost de +3dB</strong> abaixo de 100Hz. Isso d√° peso e impacto nos graves sem mascarar m√©dios e agudos. O tweeter PEI do Hertz garante extens√£o at√© 23kHz com boa dispers√£o.</p>
</div>
</div>
</div>

</div>

<script>
// Frequency points (log scale 20Hz to 20kHz)
function genFreqs(){const f=[];for(let i=Math.log10(20);i<=Math.log10(20000);i+=0.02)f.push(Math.pow(10,i));return f}
const freqs=genFreqs();
const freqLabels=freqs.map(f=>f<1000?Math.round(f)+'Hz':(f/1000).toFixed(1)+'kHz');

// Filter functions (12dB/oct = 2nd order)
function hpf12(f,fc){const r=fc/f;return -10*Math.log10(1+Math.pow(r,4))}
function lpf12(f,fc){const r=f/fc;return -10*Math.log10(1+Math.pow(r,4))}

// Subwoofer response model (Hertz ES 200.5 in ported box)
function subResponse(f){
  if(f<20)return -40;
  // Ported box tuning ~50Hz, sub resonance model
  const ft=50,Qts=0.7,fb=50;
  // Simplified ported response
  let spl=0;
  // Roll-off below tuning
  if(f<ft){const r=f/ft;spl=-24*Math.log10(ft/f)+6*Math.log10(1+Math.pow(f/fb,2))}
  // Passband with slight peak near tuning
  const peak=3*Math.exp(-Math.pow((f-ft)/15,2));
  // Natural rolloff above
  const hiRoll=f>200?-12*Math.log10(f/200):0;
  // Combine
  const loRoll=f<ft?-18*Math.log10(ft/f):0;
  spl=peak+loRoll+hiRoll;
  // Clamp to realistic range
  return Math.max(spl,-40);
}

// Mid-bass response (Hertz DSK 165.3 woofer through crossover)
function midBassResponse(f){
  if(f<30)return -40;
  // Natural response 50Hz-3.5kHz through passive crossover
  let spl=0;
  // Low end rolloff (natural, ~12dB/oct below 50Hz)
  if(f<50)spl=-12*Math.log10(50/f);
  // Slight rise at 80-150Hz (typical 6.5" in door)
  spl+=2*Math.exp(-Math.pow((Math.log10(f)-Math.log10(120))/0.3,2));
  // Slight dip at 400-600Hz (door cavity coloration, reduced by deadening)
  spl-=1.5*Math.exp(-Math.pow((Math.log10(f)-Math.log10(500))/0.2,2));
  // Breakup/rise before crossover 2-3kHz
  spl+=1*Math.exp(-Math.pow((Math.log10(f)-Math.log10(2500))/0.15,2));
  // Passive crossover LPF at 3.5kHz (12dB/oct)
  spl+=lpf12(f,3500);
  return Math.max(spl,-40);
}

// Tweeter response (Hertz PEI through crossover)
function tweeterResponse(f){
  if(f<1000)return -40;
  let spl=0;
  // Passive crossover HPF at 3.5kHz (12dB/oct)
  spl+=hpf12(f,3500);
  // Tweeter natural rise 5-8kHz (PEI dome)
  spl+=2*Math.exp(-Math.pow((Math.log10(f)-Math.log10(6000))/0.2,2));
  // Natural rolloff above 18kHz
  if(f>18000)spl-=12*Math.log10(f/18000);
  // Slight presence peak
  spl+=1*Math.exp(-Math.pow((Math.log10(f)-Math.log10(10000))/0.25,2));
  return Math.max(spl,-40);
}

// Combined 2-way kit response (through passive crossover)
function kitResponse(f){
  // Sum woofer and tweeter acoustically (power sum in dB)
  const mbdB=midBassResponse(f);
  const twdB=tweeterResponse(f);
  const mbLin=Math.pow(10,mbdB/10);
  const twLin=Math.pow(10,twdB/10);
  return 10*Math.log10(mbLin+twLin);
}

// Cabin transfer function for VW Up!
function cabinTF(f){
  let gain=0;
  // Cabin gain below 80Hz (small car = strong gain)
  if(f<200){
    const cabinGain=10*Math.pow(Math.max(0,(200-f)/200),1.5);
    gain+=cabinGain;
  }
  // Room modes (simplified for ~2.6m¬≥)
  gain+=1.5*Math.exp(-Math.pow((Math.log10(f)-Math.log10(65))/0.1,2));  // Length mode
  gain+=1*Math.exp(-Math.pow((Math.log10(f)-Math.log10(130))/0.08,2));  // 2nd mode
  gain-=2*Math.exp(-Math.pow((Math.log10(f)-Math.log10(250))/0.12,2)); // Null
  gain+=0.8*Math.exp(-Math.pow((Math.log10(f)-Math.log10(180))/0.1,2));
  // Slight HF loss from absorption
  if(f>5000)gain-=2*Math.log10(f/5000);
  return gain;
}

// Harman target curve (with bass shelf for user preference)
function harmanTarget(f){
  let t=0;
  // Bass shelf: +3dB below 100Hz, smooth transition
  if(f<200){t=3*Math.pow(Math.max(0,(200-f)/200),0.5)}
  // Slight tilt: -0.5dB/octave above 1kHz
  if(f>1000)t-=0.5*Math.log2(f/1000);
  // Presence: slight rise 2-4kHz
  t+=1*Math.exp(-Math.pow((Math.log10(f)-Math.log10(3000))/0.2,2));
  return t;
}

// Charts
let chartIndividual, chartCombined, chartFilters;

function initCharts(){
  const commonOpts={
    responsive:true,maintainAspectRatio:false,
    scales:{
      x:{type:'logarithmic',min:20,max:20000,title:{display:true,text:'Frequ√™ncia (Hz)',color:'#a0a0b0',font:{size:11}},
        ticks:{color:'#a0a0b0',font:{size:9},callback:function(v){
          const nice=[20,30,50,80,100,200,500,1000,2000,5000,10000,20000];
          if(nice.includes(Math.round(v)))return v<1000?v+'Hz':(v/1000)+'kHz';return''
        }},grid:{color:'rgba(42,42,58,.5)'}},
      y:{min:-30,max:15,title:{display:true,text:'SPL Relativo (dB)',color:'#a0a0b0',font:{size:11}},
        ticks:{color:'#a0a0b0',font:{size:9}},grid:{color:'rgba(42,42,58,.3)'}}
    },
    plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false,callbacks:{
      title:function(items){const f=items[0].parsed.x;return f<1000?Math.round(f)+' Hz':(f/1000).toFixed(1)+' kHz'},
      label:function(ctx){return ctx.dataset.label+': '+(ctx.parsed.y).toFixed(1)+' dB'}
    }}},
    interaction:{mode:'nearest',axis:'x',intersect:false},
    elements:{point:{radius:0},line:{tension:0.3}}
  };

  // Individual curves chart
  chartIndividual=new Chart(document.getElementById('chartIndividual'),{
    type:'line',data:{labels:freqs,datasets:[
      {label:'Kit 2 Vias (sistema)',data:[],borderColor:'#a29bfe',backgroundColor:'rgba(162,155,254,.1)',borderWidth:2.5,fill:true},
      {label:'Mid-Bass (via crossover)',data:[],borderColor:'#fd79a8',borderWidth:1.5,borderDash:[5,3]},
      {label:'Tweeter (via crossover)',data:[],borderColor:'#81ecec',borderWidth:1.5,borderDash:[5,3]},
      {label:'Subwoofer (caixa dutada)',data:[],borderColor:'#e17055',backgroundColor:'rgba(225,112,85,.1)',borderWidth:2.5,fill:true}
    ]},options:{...commonOpts}
  });

  // Combined system chart
  const combinedOpts=JSON.parse(JSON.stringify(commonOpts));
  combinedOpts.scales.y.min=-20;combinedOpts.scales.y.max=20;
  chartCombined=new Chart(document.getElementById('chartCombined'),{
    type:'line',data:{labels:freqs,datasets:[
      {label:'Resposta Total (banco motorista)',data:[],borderColor:'#6c5ce7',backgroundColor:'rgba(108,92,231,.15)',borderWidth:3,fill:true},
      {label:'Curva-Alvo Hi-Fi (Harman+Bass)',data:[],borderColor:'rgba(249,202,36,.7)',borderWidth:2,borderDash:[8,4]},
      {label:'Zona Ideal +3dB',data:[],borderColor:'rgba(0,184,148,.2)',backgroundColor:'rgba(0,184,148,.05)',borderWidth:1,fill:'+1'},
      {label:'Zona Ideal -3dB',data:[],borderColor:'rgba(0,184,148,.2)',backgroundColor:'rgba(0,184,148,.05)',borderWidth:1}
    ]},options:combinedOpts
  });

  // Filters chart
  const filterOpts=JSON.parse(JSON.stringify(commonOpts));
  filterOpts.scales.y.min=-35;filterOpts.scales.y.max=5;
  chartFilters=new Chart(document.getElementById('chartFilters'),{
    type:'line',data:{labels:freqs,datasets:[
      {label:'HPF Frente',data:[],borderColor:'#00b894',borderWidth:2.5},
      {label:'LPF Sub',data:[],borderColor:'#e17055',borderWidth:2.5},
      {label:'Crossover Passivo 3.5kHz (LPF Woofer)',data:[],borderColor:'#fdcb6e',borderWidth:1.5,borderDash:[5,3]},
      {label:'Crossover Passivo 3.5kHz (HPF Tweeter)',data:[],borderColor:'#81ecec',borderWidth:1.5,borderDash:[5,3]}
    ]},options:filterOpts
  });

  updateAll();
}

function updateAll(){
  const gF=parseInt(document.getElementById('gainFront').value);
  const gS=parseInt(document.getElementById('gainSub').value);
  const hpf=parseInt(document.getElementById('hpfFreq').value);
  const lpf=parseInt(document.getElementById('lpfFreq').value);
  const vol=parseInt(document.getElementById('volSource').value);

  // Update labels
  document.getElementById('gainFrontVal').textContent=gF+'%';
  document.getElementById('gainSubVal').textContent=gS+'%';
  document.getElementById('hpfVal').textContent=hpf+' Hz';
  document.getElementById('lpfVal').textContent=lpf+' Hz';
  document.getElementById('volVal').textContent=vol+'%';

  // Power calculations
  const maxPwrFront=132; // W per ch at 4ohm
  const maxPwrSub=400;   // W bridge at 4ohm
  const pwrF=maxPwrFront*Math.pow(gF/100,2);
  const pwrS=maxPwrSub*Math.pow(gS/100,2);
  const volFactor=vol/100;

  // SPL calculations
  const sensF=93, sensS=87;
  const splF=sensF+10*Math.log10(Math.max(0.1,pwrF*volFactor));
  const splS=sensS+10*Math.log10(Math.max(0.1,pwrS*volFactor));
  const cabinBoostSub=10; // avg cabin gain for sub
  const splSCabin=splS+cabinBoostSub;
  const splFBoth=splF+3; // two speakers
  const splSys=10*Math.log10(Math.pow(10,splFBoth/10)+Math.pow(10,splSCabin/10));

  document.getElementById('splFront').textContent=splFBoth.toFixed(1)+' dB';
  document.getElementById('splSub').textContent=splSCabin.toFixed(1)+' dB';
  document.getElementById('splTotal').textContent=splSys.toFixed(1)+' dB';
  document.getElementById('splPeak').textContent=(splSys+3).toFixed(1)+' dB';
  document.getElementById('pwrFront').textContent=(pwrF*volFactor).toFixed(0)+'W/ch';
  document.getElementById('pwrSub').textContent=(pwrS*volFactor).toFixed(0)+'W brg';

  // Config summary
  document.getElementById('cfgGainF').textContent=gF+'%';
  document.getElementById('cfgGainS').textContent=gS+'%';
  document.getElementById('cfgHPF').textContent=hpf+' Hz';
  document.getElementById('cfgLPF').textContent=lpf+' Hz';
  document.getElementById('cfgVol').textContent=vol+'%';
  document.getElementById('cfgPwrF').textContent='‚âà '+(pwrF*volFactor).toFixed(0)+'W por canal';
  document.getElementById('cfgPwrS').textContent='‚âà '+(pwrS*volFactor).toFixed(0)+'W bridge';

  // Gain offsets in dB
  const gainFdB=20*Math.log10(Math.max(0.01,gF/100))+20*Math.log10(Math.max(0.01,volFactor));
  const gainSdB=20*Math.log10(Math.max(0.01,gS/100))+20*Math.log10(Math.max(0.01,volFactor));

  // Update individual curves
  const kitData=[],mbData=[],twData=[],subData=[];
  freqs.forEach(f=>{
    const mb=midBassResponse(f)+hpf12(f,hpf);
    const tw=tweeterResponse(f)+hpf12(f,hpf);
    const kit=10*Math.log10(Math.pow(10,mb/10)+Math.pow(10,tw/10));
    const sub=subResponse(f)+lpf12(f,lpf);
    kitData.push({x:f,y:kit});
    mbData.push({x:f,y:mb});
    twData.push({x:f,y:tw});
    subData.push({x:f,y:sub});
  });
  chartIndividual.data.datasets[0].data=kitData;
  chartIndividual.data.datasets[1].data=mbData;
  chartIndividual.data.datasets[2].data=twData;
  chartIndividual.data.datasets[3].data=subData;
  chartIndividual.update('none');

  // Update combined system response
  const combinedData=[],targetData=[],upperData=[],lowerData=[];
  freqs.forEach(f=>{
    // Front kit with gain and HPF
    const mb=midBassResponse(f)+hpf12(f,hpf)+gainFdB;
    const tw=tweeterResponse(f)+hpf12(f,hpf)+gainFdB;
    const frontLin=Math.pow(10,mb/10)+Math.pow(10,tw/10);
    // Sub with gain and LPF
    const sub=subResponse(f)+lpf12(f,lpf)+gainSdB;
    const subLin=Math.pow(10,sub/10);
    // Sum with cabin TF
    const totalLin=frontLin+subLin;
    const totalDB=10*Math.log10(Math.max(1e-10,totalLin))+cabinTF(f);
    // Normalize to ~0dB at 1kHz
    combinedData.push({x:f,y:totalDB});
    const target=harmanTarget(f);
    targetData.push({x:f,y:target});
    upperData.push({x:f,y:target+3});
    lowerData.push({x:f,y:target-3});
  });
  // Normalize combined to 0dB at 1kHz
  const ref1k=combinedData.find(d=>d.x>=1000);
  const offset=ref1k?ref1k.y:0;
  combinedData.forEach(d=>d.y-=offset);

  chartCombined.data.datasets[0].data=combinedData;
  chartCombined.data.datasets[1].data=targetData;
  chartCombined.data.datasets[2].data=upperData;
  chartCombined.data.datasets[3].data=lowerData;
  chartCombined.update('none');

  // Update filter curves
  const hpfData=[],lpfData=[],xoLpf=[],xoHpf=[];
  freqs.forEach(f=>{
    hpfData.push({x:f,y:hpf12(f,hpf)});
    lpfData.push({x:f,y:lpf12(f,lpf)});
    xoLpf.push({x:f,y:lpf12(f,3500)});
    xoHpf.push({x:f,y:hpf12(f,3500)});
  });
  chartFilters.data.datasets[0].data=hpfData;
  chartFilters.data.datasets[1].data=lpfData;
  chartFilters.data.datasets[2].data=xoLpf;
  chartFilters.data.datasets[3].data=xoHpf;
  chartFilters.update('none');
}

window.addEventListener('load',initCharts);
</script>
</body>
</html>
