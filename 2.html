<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>üîä Car Audio Analyzer V4 ‚Äî Up! TSI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent
        }

        :root {
            --bg: #0a0a0f;
            --card: #12121a;
            --card2: #1a1a28;
            --border: #2a2a3a;
            --accent: #6c5ce7;
            --accent2: #a29bfe;
            --green: #00b894;
            --orange: #fdcb6e;
            --red: #e17055;
            --cyan: #81ecec;
            --pink: #fd79a8;
            --text: #e0e0e0;
            --text2: #a0a0b0;
            --gold: #f9ca24;
            --safe-b: env(safe-area-inset-bottom, 0px)
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            padding-bottom: var(--safe-b)
        }

        .header {
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1040 50%, #0a0a1a 100%);
            padding: 20px 16px 16px;
            padding-top: max(20px, env(safe-area-inset-top));
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px)
        }

        .header h1 {
            font-size: 20px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent2), var(--cyan));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .header p {
            color: var(--text2);
            font-size: 11px;
            font-weight: 300;
            margin-top: 2px
        }

        .header .car-badge {
            display: inline-block;
            background: var(--card2);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 3px 12px;
            font-size: 10px;
            color: var(--accent2);
            margin-top: 6px
        }

        .header .version {
            font-size: 9px;
            color: var(--green);
            margin-top: 3px;
            letter-spacing: .5px
        }

        .container {
            padding: 12px;
            max-width: 600px;
            margin: 0 auto
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent)
        }

        .card h2 {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent2);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px
        }

        .card h3 {
            font-size: 11px;
            font-weight: 600;
            color: var(--text2);
            margin: 10px 0 6px;
            text-transform: uppercase;
            letter-spacing: 1px
        }

        .chart-wrap {
            position: relative;
            height: 260px;
            margin: 8px -4px;
            touch-action: pan-y
        }

        .chart-wrap.tall {
            height: 300px
        }

        .slider-group {
            margin: 12px 0
        }

        .slider-group label {
            font-size: 12px;
            color: var(--text2);
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px
        }

        .slider-group label span {
            color: var(--accent2);
            font-weight: 700;
            font-size: 13px
        }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--card2);
            outline: none;
            border: 1px solid var(--border);
            touch-action: none
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 0 12px rgba(108, 92, 231, .6), 0 2px 8px rgba(0, 0, 0, .4)
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px
        }

        .stat {
            background: var(--card2);
            border-radius: 12px;
            padding: 10px 6px;
            text-align: center;
            border: 1px solid var(--border)
        }

        .stat .val {
            font-size: 16px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent2), var(--cyan));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .stat .lbl {
            font-size: 8px;
            color: var(--text2);
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: .3px
        }

        .tip {
            background: var(--card2);
            border-left: 3px solid var(--accent);
            border-radius: 0 10px 10px 0;
            padding: 10px 12px;
            font-size: 11px;
            color: var(--text2);
            margin: 10px 0;
            line-height: 1.6
        }

        .tip strong {
            color: var(--green)
        }

        .tip.warn {
            border-left-color: var(--orange)
        }

        .tip.warn strong {
            color: var(--orange)
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600
        }

        .badge.on {
            background: rgba(0, 184, 148, .15);
            color: var(--green);
            border: 1px solid rgba(0, 184, 148, .3)
        }

        .badge.off {
            background: rgba(225, 112, 85, .15);
            color: var(--red);
            border: 1px solid rgba(225, 112, 85, .3)
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin: 6px 0
        }

        table th {
            text-align: left;
            color: var(--text2);
            font-weight: 600;
            padding: 6px;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            font-size: 9px;
            letter-spacing: .5px
        }

        table td {
            padding: 6px;
            border-bottom: 1px solid rgba(42, 42, 58, .4);
            color: var(--text)
        }

        .config-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px
        }

        .config-item {
            background: var(--card2);
            border-radius: 10px;
            padding: 10px;
            border: 1px solid var(--border)
        }

        .config-item .title {
            font-size: 9px;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: .5px;
            margin-bottom: 4px
        }

        .config-item .value {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent2)
        }

        .config-item .detail {
            font-size: 9px;
            color: var(--text2);
            margin-top: 2px
        }

        .legend-custom {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 6px 0;
            font-size: 10px
        }

        .legend-custom .item {
            display: flex;
            align-items: center;
            gap: 3px
        }

        .legend-custom .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0
        }

        .eq-3band {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 12px 0
        }

        .eq-knob {
            background: var(--card2);
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid var(--border)
        }

        .eq-knob .band-name {
            font-size: 12px;
            font-weight: 700;
            color: var(--accent2);
            margin-bottom: 2px
        }

        .eq-knob .band-range {
            font-size: 8px;
            color: var(--text2);
            margin-bottom: 6px
        }

        .eq-knob .band-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--cyan);
            margin: 4px 0
        }

        .eq-knob .band-reason {
            font-size: 9px;
            color: var(--text2);
            margin-top: 6px;
            line-height: 1.4
        }

        .section-toggle {
            width: 100%;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px 16px;
            color: var(--accent2);
            font-size: 14px;
            font-weight: 700;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            position: relative;
            overflow: hidden;
            font-family: inherit
        }

        .section-toggle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent)
        }

        .section-toggle .arrow {
            transition: transform .3s;
            font-size: 12px
        }

        .section-toggle.open .arrow {
            transform: rotate(180deg)
        }

        .section-content {
            display: none;
            animation: slideDown .3s ease
        }

        .section-content.open {
            display: block
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-8px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .analysis-col {
            font-size: 11px;
            line-height: 1.6;
            color: var(--text2);
            margin-bottom: 12px
        }

        /* V4 Preset Tabs */
        .preset-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 12px
        }

        .preset-btn {
            padding: 10px 8px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--card2);
            color: var(--text2);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            font-family: inherit;
            text-align: center
        }

        .preset-btn:hover,
        .preset-btn:active {
            border-color: var(--accent);
            color: var(--accent2)
        }

        .preset-btn.active {
            background: rgba(108, 92, 231, .2);
            border-color: var(--accent);
            color: var(--accent2);
            box-shadow: 0 0 12px rgba(108, 92, 231, .3)
        }

        .visor-display {
            display: inline-flex;
            align-items: center;
            background: var(--card2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 2px 10px;
            font-size: 18px;
            font-weight: 800;
            color: var(--green);
            font-family: 'Courier New', monospace;
            min-width: 44px;
            justify-content: center
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üîä Car Audio Analyzer</h1>
        <p>Hi-Fi ‚Äî Presets de Ganho + Visor</p>
        <div class="car-badge">üöó VW Up! TSI 2017 ‚Äî ~2.6 m¬≥</div>
        <div class="version">V4 ‚Äî Presets ‚Ä¢ Visor 0-30 ‚Ä¢ RCA 5V ‚Ä¢ Decomposi√ß√£o</div>
    </div>
    <div class="container">

        <!-- Gain Controls with Presets -->
        <div class="card">
            <h2>üéõÔ∏è Ganho ‚Äî SD 800.4</h2>
            <!-- V4: Preset Tabs -->
            <div class="preset-tabs">
                <button class="preset-btn" onclick="setPreset('max')" id="presetMax">üî• M√°ximo c/ Qualidade</button>
                <button class="preset-btn active" onclick="setPreset('potente')" id="presetPotente">üí™ Potente</button>
                <button class="preset-btn" onclick="setPreset('media')" id="presetMedia">üéµ M√©dia</button>
                <button class="preset-btn" onclick="setPreset('natural')" id="presetNatural">üåø Volume Natural</button>
            </div>
            <div id="presetDesc"
                style="font-size:10px;color:var(--text2);margin-bottom:10px;padding:6px 10px;background:var(--card2);border-radius:6px;border-left:3px solid var(--accent)">
                üí™ Ganho moderado ‚Äî Vers√°til, empolgado.
            </div>
            <div class="slider-group">
                <label>Canais 1+2 (Kit 2 Vias) <span id="gainFrontVal">40%</span></label>
                <input type="range" id="gainFront" min="0" max="100" value="40">
            </div>
            <div class="slider-group">
                <label>Canais 3+4 Bridge (Sub) <span id="gainSubVal">30%</span></label>
                <input type="range" id="gainSub" min="0" max="100" value="30">
            </div>
            <h3>Filtros</h3>
            <div class="slider-group">
                <label>HPF Frente <span id="hpfVal">80 Hz</span></label>
                <input type="range" id="hpfFreq" min="50" max="150" value="80" step="5">
            </div>
            <div class="slider-group">
                <label>LPF Sub <span id="lpfVal">80 Hz</span></label>
                <input type="range" id="lpfFreq" min="50" max="150" value="80" step="5">
            </div>
            <!-- V4: Visor slider 0-30 -->
            <div class="slider-group">
                <label>üîä Volume do Visor
                    <span><span class="visor-display" id="visorDisplay">20</span></span>
                </label>
                <input type="range" id="volSource" min="0" max="30" value="20">
            </div>
        </div>

        <!-- SPL -->
        <div class="card">
            <h2>üìä SPL ‚Äî Banco do Motorista</h2>
            <div class="stat-grid">
                <div class="stat">
                    <div class="val" id="splFront">‚Äî</div>
                    <div class="lbl">Frente</div>
                </div>
                <div class="stat">
                    <div class="val" id="splSub">‚Äî</div>
                    <div class="lbl">Sub</div>
                </div>
                <div class="stat">
                    <div class="val" id="splTotal">‚Äî</div>
                    <div class="lbl">Total</div>
                </div>
                <div class="stat">
                    <div class="val" id="splPeak">‚Äî</div>
                    <div class="lbl">Pico</div>
                </div>
                <div class="stat">
                    <div class="val" id="pwrFront">‚Äî</div>
                    <div class="lbl">W Frente</div>
                </div>
                <div class="stat">
                    <div class="val" id="pwrSub">‚Äî</div>
                    <div class="lbl">W Sub</div>
                </div>
            </div>
        </div>

        <!-- Individual Curves -->
        <div class="card">
            <h2>üìà Curvas Individuais</h2>
            <div class="legend-custom">
                <div class="item">
                    <div class="dot" style="background:#a29bfe"></div> Kit 2V
                </div>
                <div class="item">
                    <div class="dot" style="background:#fd79a8"></div> Mid
                </div>
                <div class="item">
                    <div class="dot" style="background:#81ecec"></div> Tw
                </div>
                <div class="item">
                    <div class="dot" style="background:#e17055"></div> Sub
                </div>
            </div>
            <div class="chart-wrap tall"><canvas id="chartIndividual"></canvas></div>
        </div>

        <!-- Combined -->
        <div class="card">
            <h2>üéØ Resposta Combinada</h2>
            <div class="legend-custom">
                <div class="item">
                    <div class="dot" style="background:#6c5ce7"></div> Total
                </div>
                <div class="item">
                    <div class="dot" style="background:rgba(249,202,36,.6)"></div> Hi-Fi Alvo
                </div>
                <div class="item">
                    <div class="dot" style="background:rgba(0,184,148,.4)"></div> ¬±3dB
                </div>
            </div>
            <div class="chart-wrap tall"><canvas id="chartCombined"></canvas></div>
        </div>

        <!-- Decomposition -->
        <button class="section-toggle" onclick="toggleSection(this,'decompContent')">üî¨ Decomposi√ß√£o por Driver <span
                class="arrow">‚ñº</span></button>
        <div id="decompContent" class="section-content open">
            <div class="card">
                <div class="legend-custom">
                    <div class="item">
                        <div class="dot" style="background:#6c5ce7"></div> Total
                    </div>
                    <div class="item">
                        <div class="dot" style="background:#e17055"></div> Sub
                    </div>
                    <div class="item">
                        <div class="dot" style="background:#fd79a8"></div> Mid
                    </div>
                    <div class="item">
                        <div class="dot" style="background:#81ecec"></div> Tw
                    </div>
                    <div class="item">
                        <div class="dot" style="background:rgba(249,202,36,.5)"></div> Alvo
                    </div>
                </div>
                <div class="chart-wrap tall"><canvas id="chartDecomp"></canvas></div>
            </div>
        </div>

        <!-- Filters -->
        <button class="section-toggle" onclick="toggleSection(this,'filtersContent')">üîÄ Filtros e Crossover <span
                class="arrow">‚ñº</span></button>
        <div id="filtersContent" class="section-content">
            <div class="card">
                <div class="legend-custom">
                    <div class="item">
                        <div class="dot" style="background:#00b894"></div> HPF
                    </div>
                    <div class="item">
                        <div class="dot" style="background:#e17055"></div> LPF
                    </div>
                    <div class="item">
                        <div class="dot" style="background:#fdcb6e"></div> XO 3.5k
                    </div>
                </div>
                <div class="chart-wrap"><canvas id="chartFilters"></canvas></div>
            </div>
        </div>

        <!-- EQ 3 Band -->
        <div class="card">
            <h2>üéöÔ∏è EQ ‚Äî R√°dio Original (3 Bandas)</h2>
            <div class="eq-3band">
                <div class="eq-knob">
                    <div class="band-name">üîà BASS</div>
                    <div class="band-range">~60‚Äì250 Hz</div>
                    <div class="band-value">-2</div>
                    <div class="band-reason">Sub + cabin gain cobrem. Evita boom</div>
                </div>
                <div class="eq-knob">
                    <div class="band-name">üéôÔ∏è MID</div>
                    <div class="band-range">~500‚Äì2k Hz</div>
                    <div class="band-value">+1</div>
                    <div class="band-reason">Compensa atenua√ß√£o da cabine</div>
                </div>
                <div class="eq-knob">
                    <div class="band-name">‚ú® TREBLE</div>
                    <div class="band-range">~4k‚Äì16k Hz</div>
                    <div class="band-value">0</div>
                    <div class="band-reason">Tweeter Hertz j√° tem extens√£o natural</div>
                </div>
            </div>
            <div class="tip"><strong>Loudness e Bass Boost DESLIGADOS.</strong> O m√≥dulo cuida da amplifica√ß√£o.</div>
        </div>

        <!-- Config -->
        <div class="card">
            <h2>‚úÖ Config Final</h2>
            <div class="config-summary">
                <div class="config-item">
                    <div class="title">Ganho Frente</div>
                    <div class="value" id="cfgGainF">40%</div>
                    <div class="detail" id="cfgPwrF">‚âà 21W/ch</div>
                </div>
                <div class="config-item">
                    <div class="title">Ganho Sub Bridge</div>
                    <div class="value" id="cfgGainS">30%</div>
                    <div class="detail" id="cfgPwrS">‚âà 36W</div>
                </div>
                <div class="config-item">
                    <div class="title">HPF Frente</div>
                    <div class="value" id="cfgHPF">80 Hz</div>
                    <div class="detail">12dB/oct ‚Äî ON</div>
                </div>
                <div class="config-item">
                    <div class="title">LPF Sub</div>
                    <div class="value" id="cfgLPF">80 Hz</div>
                    <div class="detail">12dB/oct ‚Äî ON</div>
                </div>
                <div class="config-item">
                    <div class="title">Volume Visor</div>
                    <div class="value" id="cfgVol">20</div>
                    <div class="detail">N√∫mero do visor</div>
                </div>
                <div class="config-item">
                    <div class="title">Preset</div>
                    <div class="value" id="cfgPreset">üí™ Potente</div>
                    <div class="detail">Vers√°til</div>
                </div>
            </div>
        </div>

        <!-- Volume Sensation -->
        <button class="section-toggle" onclick="toggleSection(this,'volContent')">üéß SPL por Visor ‚Äî 5V RCA <span
                class="arrow">‚ñº</span></button>
        <div id="volContent" class="section-content">
            <div class="card">
                <p style="font-size:10px;color:var(--text2);margin-bottom:8px">RCA: <strong
                        style="color:var(--cyan)">5V</strong> = <strong style="color:var(--green)">+8dB
                        headroom</strong>. Visor 0-30, curva n√£o-linear.</p>
                <table id="volSensationTable">
                    <tr>
                        <th>Visor</th>
                        <th>SPL</th>
                        <th>W Fr</th>
                        <th>W Sub</th>
                        <th>Sensa√ß√£o</th>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Equipamentos -->
        <button class="section-toggle" onclick="toggleSection(this,'equipContent')">üìã Equipamentos <span
                class="arrow">‚ñº</span></button>
        <div id="equipContent" class="section-content">
            <div class="card">
                <table>
                    <tr>
                        <th>Item</th>
                        <th>Modelo</th>
                        <th>RMS</th>
                    </tr>
                    <tr>
                        <td>M√≥dulo</td>
                        <td>SD 800.4 EVO6</td>
                        <td>4√ó132W / 2√ó400W brg</td>
                    </tr>
                    <tr>
                        <td>Kit 2V</td>
                        <td>Hertz DSK 165.3</td>
                        <td>80W/lado</td>
                    </tr>
                    <tr>
                        <td>Sub</td>
                        <td>Hertz ES 200.5</td>
                        <td>200W</td>
                    </tr>
                    <tr>
                        <td>Manta</td>
                        <td>Viscoel√°stica</td>
                        <td>Portas</td>
                    </tr>
                    <tr>
                        <td>Conversor RCA</td>
                        <td>Hi-Lo Converter</td>
                        <td>5V RMS</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Checklist -->
        <button class="section-toggle" onclick="toggleSection(this,'checkContent')">üìù Checklist Instala√ß√£o <span
                class="arrow">‚ñº</span></button>
        <div id="checkContent" class="section-content">
            <div class="card">
                <table>
                    <tr>
                        <td>‚úÖ</td>
                        <td>Manta portas dianteiras</td>
                        <td><span class="badge on">Essencial</span></td>
                    </tr>
                    <tr>
                        <td>‚úÖ</td>
                        <td>Crossover passivo Hertz</td>
                        <td><span class="badge on">Do kit</span></td>
                    </tr>
                    <tr>
                        <td>‚úÖ</td>
                        <td>Cabo 7 AWG (10mm¬≤)</td>
                        <td><span class="badge on">Obrigat√≥rio</span></td>
                    </tr>
                    <tr>
                        <td>‚úÖ</td>
                        <td>Fus√≠vel 40A</td>
                        <td><span class="badge on">Seguran√ßa</span></td>
                    </tr>
                    <tr>
                        <td>‚úÖ</td>
                        <td>Terra s√≥lido</td>
                        <td><span class="badge on">Performance</span></td>
                    </tr>
                    <tr>
                        <td>‚ö†Ô∏è</td>
                        <td>RCA blindado</td>
                        <td><span class="badge on">Recomendado</span></td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Analysis -->
        <button class="section-toggle" onclick="toggleSection(this,'analysisContent')">üß† An√°lise T√©cnica <span
                class="arrow">‚ñº</span></button>
        <div id="analysisContent" class="section-content">
            <div class="card">
                <div class="analysis-col">
                    <h3>Sub + Kit 2 Vias</h3>
                    <p>Crossover em <strong style="color:var(--green)">80Hz</strong> √© ideal. HPF protege mid-bass. Sub
                        cobre 30‚Äì80Hz.</p>
                    <h3>Sub-Bass (~+6dB)</h3>
                    <p>Pico em ~+6dB. Grave profundo sem mascarar m√©dios.</p>
                    <h3>M√©dios (200‚Äì550Hz)</h3>
                    <p>Depress√£o de ~-1.5dB √© <strong style="color:var(--orange)">inerente</strong> a mid-bass 6.5" em
                        porta. Manta reduz de -4dB para -1.5dB.</p>
                </div>
            </div>
        </div>

        <div style="text-align:center;padding:20px 0;font-size:9px;color:var(--border)">Car Audio Analyzer V4 Mobile ‚Äî
            VW Up! TSI 2017 ‚Äî RCA 5V</div>
    </div>

    <script>
        function toggleSection(btn, id) { const c = document.getElementById(id); const open = c.classList.toggle('open'); btn.classList.toggle('open', open) }

        function genFreqs() { const f = []; for (let i = Math.log10(20); i <= Math.log10(20000); i += 0.03)f.push(Math.pow(10, i)); return f }
        const freqs = genFreqs();

        const vRCA = 5.0, vRef = 2.0;
        const rcaBoostDB = 20 * Math.log10(vRCA / vRef);

        // V4: Presets
        const presets = {
            max: { gF: 78, gS: 65, emoji: 'üî•', name: 'M√°ximo c/ Qualidade', desc: 'üî• Ganho alto ‚Äî Performance m√°xima.' },
            potente: { gF: 40, gS: 30, emoji: 'üí™', name: 'Potente', desc: 'üí™ Ganho moderado ‚Äî Vers√°til, empolgado.' },
            media: { gF: 30, gS: 20, emoji: 'üéµ', name: 'M√©dia', desc: 'üéµ Ganho conservador ‚Äî Dia a dia confort√°vel.' },
            natural: { gF: 17, gS: 11, emoji: 'üåø', name: 'Volume Natural', desc: 'üåø Ganho m√≠nimo ‚Äî M√°x ~113dB.' }
        };
        let activePreset = 'potente';

        function setPreset(id) {
            const p = presets[id];
            document.getElementById('gainFront').value = p.gF;
            document.getElementById('gainSub').value = p.gS;
            activePreset = id;
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('preset' + id.charAt(0).toUpperCase() + id.slice(1)).classList.add('active');
            document.getElementById('presetDesc').innerHTML = p.desc;
            document.getElementById('cfgPreset').textContent = p.emoji + ' ' + p.name;
            updateAll();
        }

        // V4: VW Up! TSI display ‚Üí power mapping
        function displayToPower(d) {
            const pts = [[0, 0], [5, 0.03], [10, 0.09], [15, 0.22], [20, 0.50], [25, 0.77], [27, 0.80], [30, 1.00]];
            if (d <= 0) return 0.0001;
            if (d >= 30) return 1.0;
            for (let i = 0; i < pts.length - 1; i++) {
                if (d >= pts[i][0] && d <= pts[i + 1][0]) {
                    const [d0, p0] = pts[i], [d1, p1] = pts[i + 1];
                    return Math.max(0.0001, p0 + (p1 - p0) * (d - d0) / (d1 - d0));
                }
            }
            return 1.0;
        }

        function hpf12(f, fc) { return -10 * Math.log10(1 + Math.pow(fc / f, 4)) }
        function lpf12(f, fc) { return -10 * Math.log10(1 + Math.pow(f / fc, 4)) }

        function subResponse(f) {
            if (f < 20) return -40;
            const ft = 50;
            const peak = 2.2 * Math.exp(-Math.pow((f - ft) / 18, 2));
            const loRoll = f < ft ? -15 * Math.log10(ft / f) : 0;
            const hiRoll = f > 200 ? -12 * Math.log10(f / 200) : 0;
            return Math.max(peak + loRoll + hiRoll, -40);
        }

        function midBassResponse(f) {
            if (f < 30) return -40;
            let spl = 0;
            if (f < 50) spl = -12 * Math.log10(50 / f);
            spl += 2 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(120)) / 0.3, 2));
            spl -= 1.0 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(450)) / 0.22, 2));
            spl += 1 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(2500)) / 0.15, 2));
            spl += lpf12(f, 3500);
            return Math.max(spl, -40);
        }

        function tweeterResponse(f) {
            if (f < 1000) return -40;
            let spl = hpf12(f, 3500);
            spl += 2 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(6000)) / 0.2, 2));
            if (f > 18000) spl -= 12 * Math.log10(f / 18000);
            spl += 1 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(10000)) / 0.25, 2));
            return Math.max(spl, -40);
        }

        function cabinTF(f) {
            let g = 0;
            if (f < 200) g += 7 * Math.pow(Math.max(0, (200 - f) / 200), 1.3);
            g += 1.2 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(65)) / 0.1, 2));
            g += 0.8 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(130)) / 0.08, 2));
            g -= 1.5 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(250)) / 0.12, 2));
            g += 0.6 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(180)) / 0.1, 2));
            if (f > 5000) g -= 2 * Math.log10(f / 5000);
            return g;
        }

        function harmanTarget(f) {
            let t = 0;
            if (f < 200) t = 6 * Math.pow(Math.max(0, (200 - f) / 200), 0.6);
            if (f > 1000) t -= 0.5 * Math.log2(f / 1000);
            t += 1 * Math.exp(-Math.pow((Math.log10(f) - Math.log10(3000)) / 0.2, 2));
            return t;
        }

        let cI, cC, cD, cF;
        const mobileFont = { size: 8 }, mobileTitleFont = { size: 9 };

        function initCharts() {
            const base = {
                responsive: true, maintainAspectRatio: false, animation: { duration: 0 },
                scales: {
                    x: {
                        type: 'logarithmic', min: 20, max: 20000, title: { display: true, text: 'Hz', color: '#a0a0b0', font: mobileTitleFont },
                        ticks: {
                            color: '#a0a0b0', font: mobileFont, maxTicksLimit: 8, callback: function (v) {
                                const n = [20, 50, 100, 200, 500, 1000, 5000, 20000];
                                if (n.includes(Math.round(v))) return v < 1000 ? v : (v / 1000) + 'k'; return ''
                            }
                        }, grid: { color: 'rgba(42,42,58,.4)' }
                    },
                    y: { min: -30, max: 15, title: { display: false }, ticks: { color: '#a0a0b0', font: mobileFont, maxTicksLimit: 6 }, grid: { color: 'rgba(42,42,58,.2)' } }
                },
                plugins: {
                    legend: { display: false }, tooltip: {
                        enabled: true, mode: 'nearest', intersect: false, titleFont: mobileFont, bodyFont: mobileFont,
                        callbacks: {
                            title: function (i) { const f = i[0].parsed.x; return f < 1000 ? Math.round(f) + 'Hz' : (f / 1000).toFixed(1) + 'kHz' },
                            label: function (c) { return c.dataset.label + ': ' + c.parsed.y.toFixed(1) + 'dB' }
                        }
                    }
                },
                interaction: { mode: 'nearest', axis: 'x', intersect: false },
                elements: { point: { radius: 0 }, line: { tension: 0.3, borderWidth: 2 } }
            };

            cI = new Chart(document.getElementById('chartIndividual'), {
                type: 'line', data: {
                    labels: freqs, datasets: [
                        { label: 'Kit 2V', data: [], borderColor: '#a29bfe', backgroundColor: 'rgba(162,155,254,.08)', fill: true, borderWidth: 2.5 },
                        { label: 'Mid', data: [], borderColor: '#fd79a8', borderWidth: 1.5, borderDash: [4, 3] },
                        { label: 'Tw', data: [], borderColor: '#81ecec', borderWidth: 1.5, borderDash: [4, 3] },
                        { label: 'Sub', data: [], borderColor: '#e17055', backgroundColor: 'rgba(225,112,85,.08)', fill: true, borderWidth: 2.5 }
                    ]
                }, options: { ...base }
            });

            const cOpts = JSON.parse(JSON.stringify(base));
            cOpts.scales.y.min = -20; cOpts.scales.y.max = 20;
            cC = new Chart(document.getElementById('chartCombined'), {
                type: 'line', data: {
                    labels: freqs, datasets: [
                        { label: 'Total', data: [], borderColor: '#6c5ce7', backgroundColor: 'rgba(108,92,231,.12)', borderWidth: 3, fill: true },
                        { label: 'Hi-Fi Target', data: [], borderColor: 'rgba(249,202,36,.6)', borderWidth: 2, borderDash: [6, 4] },
                        { label: '+3dB', data: [], borderColor: 'rgba(0,184,148,.15)', backgroundColor: 'rgba(0,184,148,.04)', borderWidth: 1, fill: '+1' },
                        { label: '-3dB', data: [], borderColor: 'rgba(0,184,148,.15)', borderWidth: 1 }
                    ]
                }, options: cOpts
            });

            const dOpts = JSON.parse(JSON.stringify(base));
            dOpts.scales.y.min = -20; dOpts.scales.y.max = 20;
            cD = new Chart(document.getElementById('chartDecomp'), {
                type: 'line', data: {
                    labels: freqs, datasets: [
                        { label: 'Total', data: [], borderColor: '#6c5ce7', backgroundColor: 'rgba(108,92,231,.08)', borderWidth: 3, fill: true },
                        { label: 'Sub', data: [], borderColor: '#e17055', borderWidth: 2, backgroundColor: 'rgba(225,112,85,.05)', fill: true },
                        { label: 'Mid', data: [], borderColor: '#fd79a8', borderWidth: 2, backgroundColor: 'rgba(253,121,168,.05)', fill: true },
                        { label: 'Tw', data: [], borderColor: '#81ecec', borderWidth: 2, backgroundColor: 'rgba(129,236,236,.05)', fill: true },
                        { label: 'Alvo', data: [], borderColor: 'rgba(249,202,36,.5)', borderWidth: 2, borderDash: [6, 4] }
                    ]
                }, options: dOpts
            });

            const fOpts = JSON.parse(JSON.stringify(base));
            fOpts.scales.y.min = -35; fOpts.scales.y.max = 5;
            cF = new Chart(document.getElementById('chartFilters'), {
                type: 'line', data: {
                    labels: freqs, datasets: [
                        { label: 'HPF', data: [], borderColor: '#00b894', borderWidth: 2.5 },
                        { label: 'LPF', data: [], borderColor: '#e17055', borderWidth: 2.5 },
                        { label: 'XO LP', data: [], borderColor: '#fdcb6e', borderWidth: 1.5, borderDash: [4, 3] },
                        { label: 'XO HP', data: [], borderColor: '#81ecec', borderWidth: 1.5, borderDash: [4, 3] }
                    ]
                }, options: fOpts
            });
            updateAll();
        }

        function calcSPLat(gF, gS, vf) {
            const pF = 132 * Math.pow(gF / 100, 2), pS = 400 * Math.pow(gS / 100, 2);
            const sF = 93 + 10 * Math.log10(Math.max(.001, pF * vf)) + rcaBoostDB;
            const sS = 87 + 10 * Math.log10(Math.max(.001, pS * vf)) + rcaBoostDB;
            const sFB = sF + 3, sCab = sS + 8;
            return { splSys: 10 * Math.log10(Math.pow(10, sFB / 10) + Math.pow(10, sCab / 10)), pwrF: pF * vf, pwrS: pS * vf };
        }

        function updateVolTable(gF, gS) {
            const lvls = [
                { d: 5, e: 'üîà', desc: 'Fundo musical' },
                { d: 10, e: 'üîâ', desc: 'Conversa c/ m√∫sica' },
                { d: 15, e: 'üéµ', desc: 'Volume de estrada' },
                { d: 20, e: 'üéØ', desc: 'Dia a dia empolgado' },
                { d: 25, e: 'üîä', desc: 'Muito alto' },
                { d: 27, e: '‚ö†Ô∏è', desc: 'Limite limpo r√°dio' },
                { d: 30, e: 'üö´', desc: 'M√°x ‚Äî clipping!' }
            ];
            let h = '<tr><th>Visor</th><th>SPL</th><th>W Fr</th><th>W Sub</th><th>Sensa√ß√£o</th></tr>';
            lvls.forEach(l => {
                const pf = displayToPower(l.d);
                const r = calcSPLat(gF, gS, pf);
                const bg = l.d === 20 ? ' style="background:rgba(108,92,231,.1)"' : '';
                h += `<tr${bg}><td>${l.e} ${l.d}</td><td>${r.splSys.toFixed(1)}</td><td>${r.pwrF.toFixed(1)}W</td><td>${r.pwrS.toFixed(1)}W</td><td style="font-size:9px">${l.desc}</td></tr>`;
            });
            document.getElementById('volSensationTable').innerHTML = h;
        }

        function updateAll() {
            const gF = +document.getElementById('gainFront').value;
            const gS = +document.getElementById('gainSub').value;
            const hpf = +document.getElementById('hpfFreq').value;
            const lpf = +document.getElementById('lpfFreq').value;
            const visor = +document.getElementById('volSource').value;
            const vf = displayToPower(visor);

            document.getElementById('gainFrontVal').textContent = gF + '%';
            document.getElementById('gainSubVal').textContent = gS + '%';
            document.getElementById('hpfVal').textContent = hpf + ' Hz';
            document.getElementById('lpfVal').textContent = lpf + ' Hz';
            document.getElementById('visorDisplay').textContent = visor;

            const pwrF = 132 * Math.pow(gF / 100, 2), pwrS = 400 * Math.pow(gS / 100, 2);
            const splF = 93 + 10 * Math.log10(Math.max(.001, pwrF * vf)) + rcaBoostDB;
            const splS = 87 + 10 * Math.log10(Math.max(.001, pwrS * vf)) + rcaBoostDB;
            const sCab = splS + 8, sFB = splF + 3;
            const sSys = 10 * Math.log10(Math.pow(10, sFB / 10) + Math.pow(10, sCab / 10));

            document.getElementById('splFront').textContent = sFB.toFixed(1);
            document.getElementById('splSub').textContent = sCab.toFixed(1);
            document.getElementById('splTotal').textContent = sSys.toFixed(1);
            document.getElementById('splPeak').textContent = (sSys + 3).toFixed(1);
            document.getElementById('pwrFront').textContent = (pwrF * vf).toFixed(0) + 'W';
            document.getElementById('pwrSub').textContent = (pwrS * vf).toFixed(0) + 'W';

            document.getElementById('cfgGainF').textContent = gF + '%';
            document.getElementById('cfgGainS').textContent = gS + '%';
            document.getElementById('cfgHPF').textContent = hpf + ' Hz';
            document.getElementById('cfgLPF').textContent = lpf + ' Hz';
            document.getElementById('cfgVol').textContent = visor;
            document.getElementById('cfgPwrF').textContent = '‚âà ' + (pwrF * vf).toFixed(0) + 'W/ch';
            document.getElementById('cfgPwrS').textContent = '‚âà ' + (pwrS * vf).toFixed(0) + 'W brg';

            const gFdB = 20 * Math.log10(Math.max(.01, gF / 100)) + 20 * Math.log10(Math.max(.01, Math.sqrt(vf))) + rcaBoostDB;
            const gSdB = 20 * Math.log10(Math.max(.01, gS / 100)) + 20 * Math.log10(Math.max(.01, Math.sqrt(vf))) + rcaBoostDB;

            // Individual curves (raw)
            const kD = [], mD = [], tD = [], sD = [];
            freqs.forEach(f => {
                const mb = midBassResponse(f) + hpf12(f, hpf);
                const tw = tweeterResponse(f) + hpf12(f, hpf);
                kD.push({ x: f, y: 10 * Math.log10(Math.pow(10, mb / 10) + Math.pow(10, tw / 10)) });
                mD.push({ x: f, y: mb }); tD.push({ x: f, y: tw });
                sD.push({ x: f, y: subResponse(f) + lpf12(f, lpf) });
            });
            cI.data.datasets[0].data = kD; cI.data.datasets[1].data = mD;
            cI.data.datasets[2].data = tD; cI.data.datasets[3].data = sD;
            cI.update('none');

            // Combined + decomposition
            const coD = [], taD = [], uD = [], lD = [];
            const dSub = [], dMb = [], dTw = [];
            freqs.forEach(f => {
                const mb = midBassResponse(f) + hpf12(f, hpf) + gFdB;
                const tw = tweeterResponse(f) + hpf12(f, hpf) + gFdB;
                const sub = subResponse(f) + lpf12(f, lpf) + gSdB;
                const cabin = cabinTF(f);
                const tot = 10 * Math.log10(Math.max(1e-10, Math.pow(10, mb / 10) + Math.pow(10, tw / 10) + Math.pow(10, sub / 10))) + cabin;
                coD.push({ x: f, y: tot });
                dSub.push({ x: f, y: sub + cabin });
                dMb.push({ x: f, y: mb + cabin });
                dTw.push({ x: f, y: tw + cabin });
                const t = harmanTarget(f);
                taD.push({ x: f, y: t }); uD.push({ x: f, y: t + 3 }); lD.push({ x: f, y: t - 3 });
            });
            const ref = coD.find(d => d.x >= 1000);
            const off = ref ? ref.y : 0;
            coD.forEach(d => d.y -= off);
            dSub.forEach(d => d.y -= off);
            dMb.forEach(d => d.y -= off);
            dTw.forEach(d => d.y -= off);

            cC.data.datasets[0].data = coD; cC.data.datasets[1].data = taD;
            cC.data.datasets[2].data = uD; cC.data.datasets[3].data = lD;
            cC.update('none');

            cD.data.datasets[0].data = coD.map(d => ({ ...d }));
            cD.data.datasets[1].data = dSub; cD.data.datasets[2].data = dMb;
            cD.data.datasets[3].data = dTw; cD.data.datasets[4].data = taD;
            cD.update('none');

            // Filters
            const hD = [], lpD = [], xL = [], xH = [];
            freqs.forEach(f => {
                hD.push({ x: f, y: hpf12(f, hpf) }); lpD.push({ x: f, y: lpf12(f, lpf) });
                xL.push({ x: f, y: lpf12(f, 3500) }); xH.push({ x: f, y: hpf12(f, 3500) });
            });
            cF.data.datasets[0].data = hD; cF.data.datasets[1].data = lpD;
            cF.data.datasets[2].data = xL; cF.data.datasets[3].data = xH;
            cF.update('none');

            updateVolTable(gF, gS);
        }

        // Touch-optimized
        document.querySelectorAll('input[type=range]').forEach(el => {
            el.addEventListener('input', updateAll);
            el.addEventListener('touchstart', e => e.stopPropagation(), { passive: true });
        });

        window.addEventListener('load', initCharts);
    </script>
</body>

</html>